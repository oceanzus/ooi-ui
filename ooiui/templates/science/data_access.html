{% extends "common/base.html" %}

{% block title %}
  <title>Data Access & Visualization</title>
{% endblock %}

{% block beforebootstrap %}

{% endblock %}

{% block head %}
  <link href="/css/compiled/index.css" rel="stylesheet" type="text/css" />
  <link href="/css/common/downloadModal.css" rel="stylesheet" type="text/css" />
  <link href="/css/common/streams.css" rel="stylesheet" type="text/css"/>
  <link href="/css/common/streamTableItem.css" rel="stylesheet" type="text/css" />
  <script src="/js/partials/compiled/index.js" type="text/javascript"></script>
  <link href="/css/common/plotControls.css" rel="stylesheet" type="text/css" />
  <link href="/css/compiled/data_catalog.css" rel="stylesheet" type="text/css"/>
  <link href="/css/compiled/plot.css" rel="stylesheet" type="text/css" />
  <link href='/lib/bootstrap-daterangepicker/daterangepicker.css' rel="stylesheet" type="text/css" />
  <link href="/css/data_catalog/search_sidebar.css" rel="stylesheet" type="text/css"/>

  <link href='/lib/jQRangeSlider/dest/css/iThing-min.css' rel='stylesheet' type='text/css' />
  <link href='/lib/jqgrid/css/addons/ui.multiselect.css' rel='stylesheet' type="text/css" />
  <link href="/lib/jqgrid/css/ui.jqgrid.css" rel='stylesheet' type='text/css' />
  <link href="/lib/jqgrid/css/ui.jqgrid-bootstrap.css" rel='stylesheet' type='text/css' />
  <link href="/lib/jqgrid/css/ui.jqgrid-bootstrap-ui.css" rel='stylesheet' type='text/css' />
  <script src='/lib/jQRangeSlider/dest/jQAllRangeSliders-min.js'></script>


  <script src="/js/partials/compiled/svgplot.js" type="text/javascript"></script>

  <script src="/js/partials/compiled/plotting.js" type="text/javascript"></script>

  <!-- lunr needs to be imported by a script tag -->

  <!-- TODO MOVE TO GRUNT FILE  -->
  <script src="/lib/d3/d3.min.js"></script>

  <script src="/lib/highcharts/highcharts.js"></script>
  <script src="/lib/highcharts/modules/exporting.js"></script>


  <script src="/lib/lunr.js/lunr.js" type="text/javascript"></script>

  <script src="/js/partials/compiled/index.js" type="text/javascript"></script>
  <script src="/js/compiled/svgplot.js" type="text/javascript"></script>
  <script src="/js/compiled/index.js" type="text/javascript"></script>
  <script src="/js/partials/compiled/home.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/PlatformModel.js" type="text/javascript"></script>
  <script src="/js/views/home/array_content/array_content.js" type="text/javascript"></script>
  <script src="/js/compiled/landingPages.js" type="text/javascript"></script>
  <script src="/js/compiled/data_catalog.js" type="text/javascript"></script>
  <script src="/js/compiled/plotting.js" type="text/javascript"></script>
  <script src="/js/partials/compiled/data_catalog_sidebar.js" type="text/javascript"></script>
  <link href="/css/custom/custom.css" rel="stylesheet" type="text/css"/>
  <link href="/lib/bootstrap-switch/dist/css/bootstrap3/bootstrap-switch.min.css" rel="stylesheet" type="text/css"/>

  <script type="text/javascript">
    $.jgrid.no_legacy_api = true;
    $.jgrid.useJSON = true;
  </script>

  <script type="text/javascript">
    $('body').prepend('<a href="#" class="back-to-top" tooltip="Scroll to top of page">Back to Top</a>');
    $('body').prepend('<a href="#" class="back-to-bottom" tooltip="Scroll to bottom of page">Back to Bottom</a>');
  </script>

  {% block link %}
    <!-- common/base.html -->
    {{ super() }}
  {% endblock %}
  {% block script %}
    <!-- common/base.html -->
    {{ super() }}
  {% endblock %}
{% endblock %}

{% block body %}
  <div class="container-fluid">
    <div id="navbar" class="row"></div>
  </div>

  <div id="wrapper" >
    <div id="page-content-wrapper">
      <div class="content-fluid">
        <div class="row">
          <div class="col-md-2" id="filterScrollContainer11">
            <div class="color-index" align="middle" style="padding:5px;">
              <button type='button' title='Reset Table Filters' id='resetAllFilters' class='btn btn-default' onclick='resetAllFilters();'><i style='pointer-events: none; text-align: center;'>Clear all filters and reset table.</i></button>
            </div>

            <div class="special-sidebar">
              <div class="panel">
                <div class="panel-heading js-collapse" data-target="#other-filters">Special Filters<i class="fa fa-chevron-down"></i>
                </div>
                <div class="panel-wrapper">
                  <div id="other-filters" class="panel-body collapse in">
                    <div class="other-filters pull-left">
                      <!-- Leaving out until ticket 10531 can be discussed
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="InstrumentStreamSwitch" style="padding-left: 0; padding-right: 2px;" title="Instrument Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Hidden" data-on-text="Shown" checked="False"> Instruments</label>
                      </div>
                      -->
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="EngInstrumentSwitch" style="padding-left: 0; padding-right: 2px;" title="Engineering Instrument Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Hidden" data-on-text="Shown" checked="False"> Eng Instruments</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="MetadataStreamSwitch" style="padding-left: 0; padding-right: 2px;" title="Metadata Streams Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Hidden" data-on-text="Shown" checked="False" class="BSswitch"> Metadata Streams</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="StatusStreamSwitch" style="padding-left: 0; padding-right: 2px;" title="Status Streams Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Hidden" data-on-text="Shown" checked="False" class="BSswitch"> Status Streams</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="InvalidatedStreamSwitch" style="padding-left: 0; padding-right: 2px;" title="Invalidated Streams Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Hidden" data-on-text="Shown" checked="False" class="BSswitch"> Invalidated Streams</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="MobileAssetSwitch" style="padding-left: 0; padding-right: 2px;" title="Mobile Asset Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Not Filtered" data-on-text="Filtered" checked="False" class="BSswitch"> Mobile Assets</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="AllTimesSwitch" style="padding-left: 0; padding-right: 2px;" title="All Times Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Not Filtered" data-on-text="Filtered" checked="True" class="BSswitch"> Time Range</label>
                      </div>
                      <div class="checkbox">
                        <label style="padding-left: 0;"><input id="AllDepthsSwitch" style="padding-left: 0; padding-right: 2px;" title="All Depths Switch" type="checkbox" data-handle-width="80" data-label-width="0" data-off-text="Not Filtered" data-on-text="Filtered" checked="True"> Depth Range</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="search-sidebar"></div>
          </div>
          <div class="col-md-10" id="plottingBodyContainer">
            <div id="plottingBody">
              <div>
                <div id="download-outline" class="pull-left">
                  <li id="ref_des_stream_outline"></li>
                </div>
              </div>

              <div class="row">
                <div class="col-sm-12">

                  <ul class="nav nav-tabs nav-justified plot-tool-tabs" data-tabs="tabs">
                    <li class="active default-tab-option"><a id="plot-tool-instruments-tab" href="#plot-tool-instruments" data-toggle="tab">Data Navigation</a></li>
                    <li class="disabled" id="plot-tab-nav-button">  <a href="#plot-tool-tab"  data-toggle="tab">Plotting</a></li>

                    <!--<li class="disabled"><a href="#plot-tool-events" data-toggle="tab">Events</a></li>-->
                    <li class="disabled"><a href="#plot-tool-annotations" data-toggle="tab">Annotations</a></li>
                  </ul>

                  <div id="plot-tab-content" class="tab-content">
                    <div class="tab-pane" id="plot-tool-tab">
                      <div class="row">
                        <div id='tools-panel' class="panel">
                          <div class="panel-body">
                            <div class="row">
                              <div class="pull-left">
                                <input id="showAdditionalParameters" type="checkbox" class="" name="Show Additional Parameters" value="showAdditionalParameters"> Show Additional Parameters<br>
                              </div>
                            </div>
                            <div class="row">
                              <div class="plot-tab-panel" id="plot-controls">
                                <p class="initial-text"> Please select an instrument from the Data Catalog below using the <i style='font-size:14px;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i> button.</p>
                              </div>
                            </div>
                            <div class="panel-footer clearfix">
                              <div class="pull-center">
                                <a href="#" class="btn btn-primary clear-plot-area pull-left">Clear Plot</a>
                                <a href="#" id="update-plot" class="btn btn-primary update-plot">Plot</a>
                                <a href="#" type="button" id="zoom-update-plot" class="btn btn-default zoom-update-plot">Update Plot</a>
                                <a href="#" class="btn btn-primary download-plot-data" style="margin-left: 30px;">Download Data</a>
                                <div id="isDecimated">

                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Annotation Legend-->
                      <div class="row" id="anno-row">
                        <div class="panel">
                          <div class="panel-heading">
                            Annotation Info
                          </div>
                          <div id="annotationLegend" class="panel-body" style="text-align:left; width: 100%; padding-left: 8px;">
                            <h5 class="fa fa-circle anno-pass" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Pass</h5>
                            <h5 class="fa fa-circle anno-fail" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Fail</h5>
                            <h5 class="fa fa-circle anno-suspect" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Suspect</h5>
                            <h5 class="fa fa-circle anno-not_evaluated" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Not Evaluated</h5>
                            <h5 class="fa fa-circle anno-not_available" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Not Available</h5>
                            <h5 class="fa fa-circle anno-not_operational" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Not Operational</h5>
                            <h5 class="fa fa-circle anno-pending_ingest" aria-hidden="true" style="font-size: 14px;float: left;padding-left: 10px;"> Pending Ingest</h5>
                          </div>
                          <div id="annotationInfo" style="text-align:left; width: 100%; padding-left: 8px; height: 50px; min-height: 50px; max-height: 50px;">
                            <h5 style="font-size: 14px;float: left;padding-left: 5px;"><b>Click annotation on plot for description...</b></h5>
                          </div>
                          <div class="panel-footer" style="min-height: 45px;">
                            <a href="#" id="clearAnnotationInfo" class="btn btn-primary clear-anno-info">Clear Annotation Info</a>
                          </div>

                        </div>
                      </div>

                      <div class="row">

                      </div>

                      <div class="row">
                        <div class="panel">
                          <div class="panel-heading plotting-heading">
                            Graph
                                    <span style="display:none" class="download-plot-container pull-right">
                                        <a href="#" download="image.png" type="button" title="Download" style="float:left" id="downloadImage" class="btn btn-default download-plot"><i style="font-size:14px;float:left;pointer-events: none;" class="fa fa-download" aria-hidden="true"></i></a>
                                    </span>
                          </div>
                          <div id="zoom-details" class="pull-left" style="border: 1px; m-top: 5px;" hidden>
                            <p>Zoom Details</p>
                            <p id="zoom-coordinates"></p>
                            <a href="#" type="button" id="zoom-reset-plot" class="btn btn-default zoom-reset-plot">Reset Zoom</a>
                          </div>

                          <div class="panel-body">
                            <!--  Plot section NORMAL   -->
                            <div id="plot-view">
                              {# <i class="fa fa-bar-chart" style="margin-left:50%;font-size:90px;"> </i>#}
                              {# <img src="/img/graph7.png" style="width:100%;"> #}
                              <img src="/img/plotting/graph.png" style="height:300px;width:100%;">
                            </div> <!-- #view -->
                          </div>
                        </div> <!-- panel -->
                      </div> <!-- .row -->
                    </div>

                    <div class="tab-pane active" id="plot-tool-instruments">
                      <div class="row">
                        <div id='plot-instruments-panel' class="panel">
                          <div class="scrollable-block">
                            <div class="scrollable-area">
                              <div id="instruments-scroll-body" class="panel-body">
                                <div class="plot-tab-panel" id="instruments-table">
                                  <p class="initial-text"> How to plot data:</p>
                                  <p class="initial-text"> Step 1) Please select an instrument from the Data Catalog below using the <i style='font-size:14px;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i> button.</p>
                                  <p class="initial-text"> Step 2) Click the Plotting tab above to configure and visualize your plot.</p>
                                </div> <!-- panel-table -->
                                <div class="plot-tab-panel" id="data-availability-dc">
                                  <div style="margin: 0 auto; width: 100%;padding: 10px" id="visavail_container">
                                    <p id="example"><!-- Visavail.js chart will be placed here --></p>
                                  </div>
                                </div>
                              </div> <!-- panel-body -->
                            </div> <!-- panel -->
                          </div>
                        </div>
                      </div>


                        <div class="row">

                            <div id="streamPanel">
                              <div class="color-index" align="right">
                                <div class="twelve-hours"></div><b> 12 Hours </b>
                                <div class="twenty-four-hours"></div><b> 24 Hours </b>
                                <div class="older"></div><b> Older than 24 hours </b>
                                <em>Data are sorted by end date, most recent first</em>
                              </div>

                              <!-- jqGrid -->

                                <div id="navGrid" class="redmond"></div>
                                <table id="grid" class="redmond"></table>

                            </div>

                        </div>

                    </div>

                    <div class="tab-pane" id="plot-tool-events">
                      <div class="row">
                        <div id='plot-events-panel' class="panel">
                          <div class="scrollable-block">
                            <div class="scrollable-area">
                              <div id="events-scroll-body" class="panel-body">
                                <div class="plot-tab-panel" id="events-table">
                                  <p class="initial-text"> Please select an instrument from the Data Catalog below using the <i style='font-size:14px;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i> button.</p>
                                </div> <!-- panel-table -->
                              </div> <!-- panel-body -->
                            </div> <!-- panel -->
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane" id="plot-tool-annotations">
                      <div class="row">
                        <div id='plot-annotation-panel' class="panel">
                          <div class="scrollable-block">
                            <div class="scrollable-area">
                              <div id="annotation-panel" class="panel-body">
                                <div class="plot-tab-panel" id="annotation-table">
                                  <p class="initial-text"> Please select an instrument from the Data Catalog below using the <i style='font-size:14px;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i> button.</p>
                                </div> <!-- panel-table -->
                              </div> <!-- panel-body -->
                            </div> <!-- panel -->
                          </div>
                        </div>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
              <!--<div class="col-md-12" style="text-align:center;">
                <p id="dataAvailabilityInfo"></p>
                <p id='dataAvailability'></p>
              </div>-->
            </div>
          </div>
        </div>
      </div>
    </div>
    <a href="#" class="back-to-top" tooltip="Scroll to top of page">Back to Top</a>
    <a href="#" class="back-to-bottom" tooltip="Scroll to bottom of page">Back to Bottom</a>
    <div id="stream-download-modal"></div>
    <div id='download-ok-modal'></div>
    <div id='download-fail-modal'></div>
    <div id='annotation-modal'></div>
  </div>


  <script type="text/javascript">
    var bannerTitle = "Data Access & Visualization";
    var userId = parseInt(window.location.href.split('/').pop());
    var initialLocationSearch = "";
    if(location.search != "" && location.search != "?" && location.search != null && location.search.indexOf('?search=') > -1){
      initialLocationSearch = location.search.split('?search=')[1].replace(/%20/g, ' ');
    }
    if(location.hash!=""){
      initialLocationSearch = location.hash.split('#')[1].replace(/%20/g, ' ');
      //console.log('initialLocationSearch');
      //console.log(initialLocationSearch);
    }

    var origStartDate = null;
    var origEndDate = null;

    _.extend(OOI.prototype, Backbone.Events, {
      login: new LoginModel(),
      collections: {
        annotations: new AnnotationCollection(),
        plotEventList: new PlotEventsCollection(),
        //interpolatedDataseries: new InterpolatedDataSeriesCollection(),
        subscriptionCollection :  new DataSubscriptionCollection(),
        largeFormatFiles: new LargeDataFormatCollection(),
        selectedStreamCollection: new StreamCollection(), //collection of stream models
        streams: new StreamCollection(),
        dataAvailabilityCollection: new DataAvailabilityCollection(),
        organizations: new Organizations(),
        qcFlagsCollection: new QcFlagsCollection()
      },
      views: {
        plotControls: null, //holds the view, plot controls for the plot tools tab
        plotInstruments: null, //holds the view, list of selected instruments
        plotContainer  : null,  //hold the plot content, either image or highcharts plot

        plotEventListView: null,
        annotationTableView: null
      },
      models: {
        //plotTimeModel : new PlotTimeModel(),
        plotModel     : new PlotControlModel(),
        downloadModel : new StreamModel(),
        userModel     : new UserModel(),
        dataAvailabilityModel : new DataAvailabilityModel(),
        qcFlagsModel : new QcFlagsModel()
      },
      showPlottingTabs:function(){
        $('#plottingBody .plot-tool-tabs li').removeClass('disabled');
      },
      hidePlottingTabs:function(){
        $('#plottingBody .plot-tool-tabs li').removeClass('active');

        $('#plottingBody .plot-tool-tabs li.default-tab-option a').click();
        //$($('#plottingBody .plot-tool-tabs li')[0]).addClass('active');
        $('#plottingBody .plot-tool-tabs li:not(.default-tab-option)').addClass('disabled');

      },
      plotSingleInstrument:function(parameterCollection){
        //console.log('parameterCollection');
        //console.log(parameterCollection);

        var self = this;
        //NORMAL PLOT
        //get the params
        var xParams = [];
        var yParams = [];
        var zParams = [];
        var displayName = parameterCollection.models[0].get('original_model').get('long_display_name');
        var streamName = parameterCollection.models[0].get('original_model').get('stream_name');
        var stream_display_name = parameterCollection.models[0].get('original_model').get('stream_display_name');
        var referenceDesignator = parameterCollection.models[0].get('original_model').get('reference_designator');
        parameterCollection.each(function(model){
          if (model.get('is_selected')){
            //double check the selected field and add the parameter name to the list
            if (model.get('is_x')){
              xParams.push(model.get('short_name'));
            }
            if (model.get('is_y')){
              yParams.push(model.get('short_name'));
            }
            if (model.get('is_z')){
              zParams.push(model.get('short_name'));
            }
          }
        });

        var selectDt = this.views.plotControls.getDateTimeRange();
        // update time
        self.views.plotContainer.plotParameters = parameterCollection;
        if (self.views.plotContainer.plotModel.get('plotType') == "xy"){
          //ONLY DO this for XY plot as it uses highcharts
          //get the data

          //console.log('plotData');
          //console.log(selectDt.startDate.utc());
          //console.log(selectDt.startDate.utc().toISOString());
          //console.log(selectDt.endDate.utc());
          //console.log(selectDt.endDate.utc().toISOString());

          var startDate = selectDt.startDate.clone();
          var endDate = selectDt.endDate.clone();
          if(!startDate.isUTC()){
            startDate._d.setMinutes(startDate._d.getMinutes()-startDate._d.getTimezoneOffset());
            endDate._d.setMinutes(endDate._d.getMinutes()-endDate._d.getTimezoneOffset());
          }

          // console.log(startDate);
          // console.log(endDate);

          // console.log('startDate.toISOString()');
          // console.log(startDate.toISOString());
          // console.log(startDate._i);
          // console.log(startDate.utc().format('YYYY-MM-DD[T]HH:mm:ss.SSS[Z]'));

          self.views.plotContainer.plotData = new DataSeriesCollection({},
            {
              displayName : displayName,
              stream      : streamName,
              ref_des     : referenceDesignator,
              startdate   : startDate.utc().format('YYYY-MM-DD[T]HH:mm:ss.SSS[Z]'),
              enddate     : endDate.utc().format('YYYY-MM-DD[T]HH:mm:ss.SSS[Z]'),
              xparameters : xParams,
              yparameters : yParams,
              stream_display_name : stream_display_name
            });


          var onDataHandler = function(collection, response, options) {
            self.views.plotContainer.hideLoading();
            self.views.plotContainer.render();
          };

          var errorHandler = function(collection, response,options){
            //var errorText = response.status+': '+response.statusText;
            var errorText = "There is no data available for the specified time range.";
            ooi.trigger('plot:error', {title:"Error Obtaining Data:", message: errorText});
            self.views.plotContainer.hideLoading();
          };

          //fetch the data
          self.views.plotContainer.plotData.fetch({ success : onDataHandler, error: errorHandler, reset: true});

        }else{
          self.views.plotContainer.plotDates = selectDt;
          //IMAGE PLOT generation
          self.views.plotContainer.render();
        }
      },
      plotInterpolatedData: function(parameterCollection) {
        // console.log('plotInterpolatedData');
        // console.log(parameterCollection);
        var self = this;
        var selectDt = this.views.plotControls.getDateTimeRange();
        self.views.plotContainer.plotParameters = new ParameterCollection(parameterCollection.toJSON());

        var paramCounter = 0;
        self.views.plotContainer.plotParameters.each(function(model){
          if(paramCounter > 1 && model.get('short_name') != 'time'){
            model.set({'short_name' : model.get('original_model').get('stream') + '-' + model.get('short_name')});
          }
          paramCounter++;
        });

        // console.log('self.views.plotContainer.plotParameters');
        // console.log(self.views.plotContainer.plotParameters);

        var instr1_2 = [];
        var vars1_2 = [];
        var ref_des1_2 = [];
        //INTERPOLATED PLOT 1)
        //get the params
        var xParams1 = [];
        var yParams1 = [];
        var zParams1 = [];
        var displayName = parameterCollection.models[0].get('original_model').get('long_display_name') + ' - ' + parameterCollection.models[0].get('original_model').get('stream_display_name');
        var streamName1 = parameterCollection.models[2].get('original_model').get('long_display_name') + ' - ' + parameterCollection.models[2].get('original_model').get('stream_display_name');
        var referenceDesignator1 = parameterCollection.models[0].get('original_model').get('reference_designator');
        parameterCollection.each(function(model){
          // console.log(model);
          if (model.get('is_selected')){
            if(model.get('short_name') != 'time'){
              instr1_2.push(model.get('original_model').get('stream_name'));
              vars1_2.push(model.get('short_name'));
              ref_des1_2.push(model.get('original_model').get('reference_designator'));
            }
{#            //double check the selected field and add the parameter name to the list
            if (model.get('is_x')){
              xParams1.push(model.get('short_name'));
            }
            if (model.get('is_y')){
              yParams1.push(model.get('short_name'));
            }
            if (model.get('is_z')){
              zParams1.push(model.get('short_name'));
            }#}
          }
          paramCounter++;
        });


{#        //INTERPOLATED PLOT 2)
        //get the params
        var xParams2 = [];
        var yParams2 = [];
        var zParams2 = [];
        var streamName2 = parameterCollection.models[1].get('original_model').get('stream_display_name');
        var referenceDesignator2 = parameterCollection.models[1].get('original_model').get('reference_designator');
        parameterCollection.each(function(model){
          if (model.get('is_selected')){
            instr1_2 = model.get('short_name');
            if(instr1 != 'time'){
              vars1_2.push(model.get('original_model').get('stream'));
            }
            //double check the selected field and add the parameter name to the list
            if (model.get('is_x')){
              xParams2.push(model.get('short_name'));
            }
            if (model.get('is_y')){
              yParams2.push(model.get('short_name'));
            }
            if (model.get('is_z')){
              zParams2.push(model.get('short_name'));
            }
          }
        });#}

        //xParams1 = xParams1.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);
        //yParams1 = yParams1.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);
        //xParams2 = xParams2.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);
        //yParams2 = yParams2.slice().sort(function(a,b){return a > b}).reduce(function(a,b){if (a.slice(-1)[0] !== b) a.push(b);return a;},[]);

{#        console.log('xParams1');
        console.log(xParams1);
        console.log('xParams2');
        console.log(xParams2);
        console.log('yParams1');
        console.log(yParams1);
        console.log('yParams2');
        console.log(yParams2);
        console.log('zParams1');
        console.log(zParams1);
        console.log('zParams2');
        console.log(zParams2);

        console.log('instr1_2');
        console.log(instr1_2);
        console.log('vars1_2');
        console.log(vars1_2);
        console.log('ref_des1_2');
        console.log(ref_des1_2);#}

        //create the interpolated data series collection
        self.views.plotContainer.plotData = new InterpolatedDataSeriesCollection({},
          {instr1    : instr1_2[0],
          instr2    : instr1_2[1],
          ref_des1  : ref_des1_2[0],
          ref_des2  : ref_des1_2[1],
          startdate : selectDt.startDate.toISOString(),
          enddate   : selectDt.endDate.toISOString(),
          var1      : vars1_2[0],
          var2      : vars1_2[1],
          displayName: displayName,
          stream_display_name: streamName1}
        );

        var onDataHandler = function(collection, response, options) {
          self.views.plotContainer.hideLoading();
          self.views.plotContainer.render();
        };

        var errorHandler = function(collection, response,options){
          //var errorText = response.status+': '+response.statusText;
          var errorText = "There is no data available for the specified time range.";
          ooi.trigger('plot:error', {title:"Error Obtaining Data:", message: errorText});
          self.views.plotContainer.hideLoading();
        };

        //fetch the data
        self.views.plotContainer.plotData.fetch({ success : onDataHandler, error: errorHandler, reset: true});


      },
      getURLParameter: function(sParam) {
        var sPageURL = window.location.search.substring(1);
        var sURLVariables = sPageURL.split('&');
        for (var i=0; i < sURLVariables.length; i++) {
          var sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] == sParam) {
            return sParameterName[1];
          }
        }
      },
      start: function() {
        var self = this;
        var ciLogonToken = this.getURLParameter('token'),
          ciLogonTimeout = this.getURLParameter('expiration');
        if (ciLogonToken) {
          var date = new Date();
          date.setTime(date.getTime() + ciLogonTimeout*1000);
          $.cookie('ooiusertoken', ciLogonToken, {expires: date});
          ooi.trigger('login:success');
        }
        this.login.fetch({async:false});

        // console.log('this.login in data_access');
        // console.log(this.login);

        if(this.login.loggedIn()) {
          // console.log('this.models.userModel');
          // console.log(this.models.userModel);
          this.models.userModel.fetch({url: '/api/current_user'});
          this.models.qcFlagsModel.fetch();
        }

        //reset the subscriptions
        if (ooi.models.userModel.length > 0) {
          self.collections.subscriptionCollection.fetch({reset: true});
        }
        this.listenTo(self.collections.subscriptionCollection, 'reset', function(options) {
        });

        //--------------------------------------------------------------------------------
        // Views
        //--------------------------------------------------------------------------------
        this.views.banner = new BannerView({bannerTitle: bannerTitle});
        $('body').prepend(this.views.banner.el);

        this.views.navbar = new NavbarView({
          el: $('#navbar')
        });
        $('body').prepend(this.views.navbar.el);

        //INITIALIZE TABS
        //PLOT CONTROLS

        this.views.plotControls = new PlotControlView({
          el: $('#plot-controls'),
          collection: self.collections.selectedStreamCollection,
          plotModel : self.models.plotModel
        });

        this.views.plotInstruments = new PlotInstrumentView({
          el: $('#instruments-table'),
          collection: self.collections.selectedStreamCollection
        });

        this.views.plotContainer = new PlotView({
          el: $('#plot-view')
        });

        this.views.annotationTableView = new AnnotationTableView({
          collection: self.collections.annotations,
          el: $('#annotation-table')
        });

        this.views.annotationModal = new AnnotationModalFormView({
          el: $('#annotation-modal')
        });

        this.views.streamDownloadFormView = new StreamDownloadFormView({
          el: $('#stream-download-modal')
        });

        this.views.largeFileFormatView = new LargeDataTableView({
          collection: this.collections.largeFormatFiles,
          el: $('#large-format-file-view')
        });

        this.views.modalDownloadView = new ModalDownloadView({
          el: $('#download-ok-modal')
        });

        this.views.modalDownloadFailView = new ModalDownloadFailView({
          el: $('#download-fail-modal')
        });

        this.views.plotEventListView = new PlotEventListView({
          el: $('#events-table'),
          collection : self.collections.plotEventList
        });

        // Get the list of streams from the API
        {#updateCollection( showStreams );#}

        /* Dispatcher Sectiion */
        this.listenTo(this, "login:success", function() {
          // console.log('login successful');
          if(this.login.loggedIn()) {
            this.models.userModel.fetch({url: '/api/current_user'});
            this.models.qcFlagsModel.fetch();
          }
          window.location.reload(true);
        });

        $("#plot-tab-nav-button").on('click', function(e){
          if ($("#plot-controls > div > div > div.col-sm-8.plot-instrument-column > div.instrument-content > div > table > tbody > tr:nth-child(2) > td:nth-child(1) > div > div > button > span.filter-option.pull-left").text() !== "Select a parameter") {
            ooi.trigger('update_plot', {});
          }
        });

        this.listenTo(this, "login:logout", function() { window.location.reload(true); });

        this.listenTo(this, 'StreamTableItemView:onClick', function(options) {
          if(this.login.loggedIn()) {

            options.model.attributes.email = this.models.userModel.get("email");
            options.model.attributes.user_name = this.models.userModel.get("user_name");

            var hasSubscribed = false;
            //for email address
            var availSubs = self.collections.subscriptionCollection.where({email:this.models.userModel.get("email")});
            //for selected item
            var currentStream = options.model.get('stream_name');
            var currentRef = options.model.get('ref_des');
            //loop over and compare, only if telemetered
            if (currentStream.split('_')[0] == 'telemetered'){
              _.each(availSubs,function(sub){
                var refDes = sub.attributes.referenceDesignator.subsite+"-"+sub.attributes.referenceDesignator.node+"-"+sub.attributes.referenceDesignator.sensor;

                var streamName = sub.get('method').replace(/_/g,"-") +"_"+sub.get('stream').replace(/_/g,"-");
                if (streamName == currentStream && refDes == currentRef){
                  hasSubscribed = true;
                  options.model.set('subscriptionModel',sub);
                }
              });
            }

            if (hasSubscribed){
              options.model.set('subscriptionEnabled', true);
            }else{
              options.model.set('subscriptionEnabled', false);
            }

            self.views.streamDownloadFormView.show(options);
          }
        });

        this.listenTo(this, 'TimeRangeFilterView:addToTimeRange', function(options) {
          // console.log('addToTimeRange');
          var startDate = new Date(options.min).toISOString(),
            endDate   = new Date(options.max).toISOString();

          setTimeRangeFilter("start", startDate, "end", endDate);
          combineFilters();
        });

        this.listenTo(this, 'DepthRangeFilterView:change', function(options) {
          //console.log('DepthRangeFilterView:change');
          //console.log(options);
          setDepthRangeFilter("depth", options.min, options.max);
          combineFilters();
        });

        this.listenTo(this, 'StreamFilterView:addToStreamFilters', function(options) {
{#          console.log('addToStreamFilters');#}
          setStreamFilter("reference_designator", options);
          combineFilters();
        });

        this.listenTo(this, 'StreamFilterView:addToStreamDeliveryFilters', function(options) {
{#          console.log('addToStreamFilters');#}
          setStreamFilter("stream_method", options);
          combineFilters();
        });

        this.listenTo(this, 'PlatformFilterView:add', function(options) {
          //console.log('PlatformFilterView:add');
          setPlatformFilter("reference_designator", options);
          combineFilters();
        });

        this.listenTo(this, 'NodeFilterView:add', function(options) {
          //console.log('NodeFilterView:add');
          setNodeFilter("reference_designator", options);
          combineFilters();
        });

        this.listenTo(this, 'InstrumentFilterView:addToInstrumentFilters', function(options) {
{#          console.log('addToInstrumentFilters');#}
          setInstrumentFilter("reference_designator", options);
          combineFilters();
        });

        this.listenTo(this, 'ArrayFilterView:addToFilters', function(options) {
          //console.log('addToFilters');
          //console.log(options);
          setArrayFilter("reference_designator", options);
          combineFilters();
          {#          showCurrentFilters();#}
        });

        this.listenTo(self.models.userModel, 'change', function(options) {
          //reset the subscriptions, once loaded
          self.collections.subscriptionCollection.fetch({ reset: true, data: {email:self.models.userModel.get("email")} });
        });

        this.listenTo(this, 'StreamDownloadFormView:resetSubscriptionCollection', function() {
          self.collections.subscriptionCollection.fetch({ reset: true, data: {email:self.models.userModel.get("email")} });
        });

        this.listenTo(this, 'show_additional_parameters', function(options) {
          self.views.plotControls.setAdditionalParameterVisibility();
        });

        //MAIN ADDITION OF A STREAM
        this.listenTo(this, "add_catalog_model", function(o) {
          //o.model = selected stream model
          //ONLY ALLOW TWO instruments selected
          // if (self.collections.selectedStreamCollection.length < 2){
            self.showPlottingTabs();
            // This is where the selectedStreamCollection needs to go out and fetch the parameter info for the plotting model
            // console.log('adding model to selectedStreamCollection');
            // console.log(o.model);
            // console.log(o);
            var ref_des = o.model.get('ref_des'),
              stream_method = o.model.get('stream_method'),
              stream = o.model.get('stream');
            var newUrl = '/api/uframe/get_stream_for_model?ref_des='+ref_des+'&stream_method='+stream_method+'&stream='+stream;
            var streamWithParameters = new StreamCollection();
            streamWithParameters.fetch({url: newUrl, async:false});
            // console.log(streamWithParameters.models[0]);
            // console.log('streamWithParameters');
            // console.log(streamWithParameters);
            // TODO: Check that the model is > 0
            self.collections.selectedStreamCollection.add(streamWithParameters.models[0]);
            self.trigger('update_catalog_list',{});
            if (!_.isUndefined(o.evt)){
              o.evt.find('i').removeClass('fa-plus-square').addClass('fa-minus-square');
            }else{
              var rowId = val = o.model.get('ref_des') + o.model.get('stream_name');
              $($dcGrid.getGridRowById(rowId)).find('.instrument-to-plot i').removeClass('fa-plus-square').addClass('fa-minus-square')
            }
            var selectedStreamUrl =  "#" + o.model.get('ref_des') + "/" + o.model.get('stream_name');
            var selectedStreamObj = {"ref_des": o.model.get('ref_des'), "stream_name": o.model.get('stream_name')};
            // console.log("add_catalog_model");
            // console.log(selectedStreamObj);
            // console.log(selectedStreamUrl);
            placeDataAvailability(selectedStreamObj);
            history.pushState(selectedStreamObj, 'selectStream', selectedStreamUrl);
          //}
        });

        //MAIN ADDITION OF A STREAM
        this.listenTo(this, "remove_catalog_model", function(o) {
          //o.model = selected stream model
          //ONLY ALLOW TWO instruments selected

          // console.log("remove_catalog_model");
          // console.log(o.model);
          // console.log(self.collections.selectedStreamCollection);

          // people.remove(people.where({name: "joe3"}));
          self.collections.selectedStreamCollection.remove(self.collections.selectedStreamCollection.where({unique_id: o.model.get('unique_id')}));
          // console.log('after remove');
          // console.log(self.collections.selectedStreamCollection);

          if (self.collections.selectedStreamCollection.length == 0){
            self.hidePlottingTabs();
          }

          //reset the content
          $('#plot-view').html('<img src="/img/plotting/graph.png" style="height:400px;width:100%;">');
          self.trigger('update_catalog_list',{});

          var newurl = window.location.protocol + "//" + window.location.host + window.location.pathname;

          // console.log(o.model);
          $('#div_'+o.model.get('reference_designator')+o.model.get('stream_name')).remove();

          history.back();
          // console.log(location.href);
        });

        this.listenTo(this, "reset_catalog_list", function(o) {
          //listen to change events
          self.collections.selectedStreamCollection.reset();
          self.trigger('update_catalog_list',{});
          //reset tabs
          self.hidePlottingTabs();
        });

        this.listenTo(this, "plotControlView:update_xy_chart", function(o) {
          //renders the xy chart
          if(o !== undefined){
            //console.log('updating chart');
            self.views.plotContainer.showUpdateLoading();
            self.views.plotContainer.updateChart(o.model);
          }
        });

        this.listenTo(this, "plot:plotLoaded", function(o) {
          self.views.plotContainer.hideUpdateLoading();
        });

        this.listenTo(this, "plotControlView:change_plot_type", function(o) {
          //changes the plot type
          $('.download-plot-container').css('display','none');
          self.views.plotControls.render();
        });

        this.listenTo(this, "update_annotation_table", function(o){
          //ANNOTATIONS
          self.collections.annotations.fetch({
            data: $.param({
              startdate: self.collections.selectedStreamCollection.models[0].get('start'),
              enddate:  self.collections.selectedStreamCollection.models[0].get('end'),
              reference_designator: self.collections.selectedStreamCollection.models[0].get('reference_designator'),
              stream_name: self.collections.selectedStreamCollection.models[0].get('stream_name'),
              stream_display_name: self.collections.selectedStreamCollection.models[0].get('stream_display_name')
            }),
            reset: true
          });
        });

        this.listenTo(this, "update_catalog_list", function(o) {
          //get plot defaults for instrument
          if (self.collections.selectedStreamCollection.length > 0){
            var items = self.collections.selectedStreamCollection.models[0].get('ref_des').split('-');
            var item = items[items.length-1];
            var new_item = item.replace(/\d+/g, '');

            self.views.plotControls.plotDefaultModel = null;

            defaultPlotTypes.each(function(plotStyle){
              if (new_item.indexOf(plotStyle.get('instrument')) > -1){
                self.views.plotControls.plotDefaultModel = plotStyle;
              }
            });
          }

          //render the controls
          self.views.plotControls.render();
          self.views.plotInstruments.render();

          if (self.collections.selectedStreamCollection.length > 0){
            //EVENTS
            {#self.collections.plotEventList.fetch({
              reset: true,
              data: $.param({
                ref_des: self.collections.selectedStreamCollection.models[0].get('reference_designator')
              })
            });#}

            //ANNOTATIONS
            self.collections.annotations.fetch({
              data: $.param({
                startdate: self.collections.selectedStreamCollection.models[0].get('start'),
                enddate:  self.collections.selectedStreamCollection.models[0].get('end'),
                reference_designator: self.collections.selectedStreamCollection.models[0].get('reference_designator'),
                stream_name: self.collections.selectedStreamCollection.models[0].get('stream_name'),
                stream_display_name: self.collections.selectedStreamCollection.models[0].get('stream_display_name')
              }),
              reset: true
            });
            $('#zoom-update-plot').prop('disabled',true);
            $('#zoom-update-plot').hide();
            $('#zoom-reset-plot').prop('disabled',true);
            $('#zoom-reset-plot').hide();
          }else{
            //reset is empty
            self.collections.annotations.reset();
            self.views.annotationTableView.emptyRender();

            self.collections.plotEventList.reset();
            self.views.plotEventListView.emptyRender();
          }
        });

        this.listenTo(this, "updateCalendarZoom", function(o) {
          //console.log('updateCalendarView');
          //console.log(o);
          //console.log(o.startDate);
          //console.log(o.endDate);

          self.views.plotControls.updateDateTimeRange(moment.utc(o.startDate), moment.utc(o.endDate));
        });

        this.listenTo(this, "update_plot", function(o) {
          //update the plot when "plot" is clicked
          //get the plot control model and create the
          //hide the download button
          $('#plot-view').empty();
          $('.download-plot-container').css('display','none');
          $('#zoom-details').hide();

          //console.log('update_plot');

          self.views.plotContainer.plotModel = this.views.plotControls.plotModel;
          //console.log('self.views.plotContainer.plotModel');
          //console.log(self.views.plotContainer);

          //get the selected parameters, only plot is they meet the criteria
          //will be null if the inputs dont conform
          var parameterCollection = this.views.plotControls.getSelectedParameters(self.collections.selectedStreamCollection.length);

          if (!_.isNull(parameterCollection)){
            // console.log('parameterCollection');
            // console.log(parameterCollection);
            self.views.plotContainer.showLoading();

            if (self.collections.selectedStreamCollection.length == 1){
              self.plotSingleInstrument(parameterCollection);
            }else{
              self.plotInterpolatedData(parameterCollection);
            }
          }
        });

        this.listenTo(this, "clear_plot_area", function(o) {
          $('#plot-view').empty();
        });

        this.listenTo(this, "download_plot_data", function(o) {
          //update the plot when "plot" is clicked
          //get the plot control model and create the
          //hide the download button
          //console.log('clicked download-plot-data');
          //console.log(o);
          $('.download-plot-container').css('display','none');
          if(this.login.loggedIn()) {
            var ref_des = self.collections.selectedStreamCollection.models[0].get('reference_designator');
            var stream_name = self.collections.selectedStreamCollection.models[0].get('stream_name');
            //console.log(ref_des);
            //console.log(stream_name);
            var dtRange = this.views.plotControls.getDateTimeRange();
            //console.log(dtRange);
            openDownload(ref_des, stream_name, dtRange);
          } else {
            var daWarning = new ModalDialogView();
            var theMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
            theMessage += "Please log in to download data.";
            theMessage += "</div>";
            daWarning.show({
              message: theMessage,
              type: "warning"
            });
          }
        });

        this.listenTo(this, "plot:error", function(o) {
          console.log('ERROR: Reason:',o.message);
          //if error reset the plot window and xy plot
          $('#plot-view').width('100%');
          $('#plot-view').height('400px');
          self.views.plotContainer.xyPlot = undefined;

          bootbox.dialog({
            message: o.message,
            title: o.title,
            buttons: {
              success: {
                label: "OK",
                className: "btn-primary",
                callback: function() {
                }
              }
            }
          });

          //reset the content
          $('#plot-view').empty();
          $('#plot-view').html('<img src="/img/plotting/graph.png" style="height:400px;width:100%;">');
          $('#plot-view').css('height','400px');

        });

        //render the annotations
        this.listenTo(self.collections.annotations, 'reset', function(collection) {
          self.views.annotationTableView.render();
          if(self.login.loggedIn()) {
            $('#addAnnotation').show();
          }else{
            $('#addAnnotation').hide();
          }
        });

        // render the events
        this.listenTo(this.collections.plotEventList, 'reset', function(collection) {
          self.views.plotEventListView.render()
        });

        //
        this.listenTo(this, 'AnnotationModalFormView:onSubmit99', function(model) {
          //console.log('onSubmit99');
          //console.log(model);
          $.when(self.collections.annotations.add(model)).done( function(ret){
            //console.log(ret);
            self.trigger('update_annotation_table',{});
            self.views.annotationTableView.render();
          })
        });

        //
        this.listenTo(this, 'AnnotationModalFormView:onUpdate99', function(model) {
          //console.log('onUpdate99');
          //console.log(model);

          $.when(self.collections.annotations.add(model)).done( function(ret){
            // console.log(ret);
            self.trigger('update_annotation_table',{});
            self.views.annotationTableView.render();
          })
        });

        this.listenTo(this, 'AnnotationTableItemView:onClick', function(model) {

          var min = moment.utc(new Date(model.get('beginDT'))).toISOString();
          var max = moment.utc(new Date(model.get('endDT'))).toISOString();
          {#console.log('AnnotationTableItemView:onClick');
          console.log("model.get('beginDT')");
          console.log(model.get('beginDT'));
          console.log("model.get('endDT')");
          console.log(model.get('endDT'));
          console.log(max);#}

          model.set('beginDTSafe',min);
          if(model.get('endDT') !== null){
            model.set('endDTSafe',max);
          }else{
            model.set('endDTSafe', null);
          }


          if(self.login.loggedIn()) {
            self.views.annotationModal.show({
              model: model,
              userModel: self.models.userModel,
              qcFlagsModel: self.models.qcFlagsModel,
              showUpdate: true
            });
          }
        });

        this.listenTo(this, 'AnnotationTableItemView:onClickDelete', function(model) {
          // console.log('Deleting annotation');
          // console.log(model);

          $.when(self.collections.annotations.remove(model)).done( function(ret){
            // console.log(ret);
            self.trigger('update_annotation_table',{});
            self.views.annotationTableView.render();
          })
        });

        this.listenTo(this, 'AnnotationModalFormView:onError', function(e) {
          var daWarning = new ModalDialogView();
          daWarning.show({
            message: "Error saving annotation.<br>"+e.responseText,
            type: "warning"
          });
          self.trigger('update_annotation_table',{});
          self.views.annotationTableView.render();
        });

        this.listenTo(this, 'AnnotationTableView:onAddClick', function() {
          var model = self.collections.selectedStreamCollection.models[0];
          var min = moment.utc(model.get('start')).format("YYYY-MM-DD HH:mm:ss.SSS");
          var max = moment.utc(model.get('end')).format("YYYY-MM-DD HH:mm:ss.SSS");

          var annoModel = new AnnotationModel({
            "referenceDesignator": model.get('reference_designator'),
            "beginDTSafe": min,
            "endDTSafe": max,
            "beginDT": null,
            "endDT": null,
            "method": model.get("method"),
            "stream_name": model.get("stream_name"),
            "qcFlag": "not_evaluated",
            "exclusionFlag": null,
            "node": model.get("node"),
            "sensor": model.get("sensor"),
            "stream": model.get("stream"),
            "subsite": model.get("subsite")
          });

          if(self.login.loggedIn()) {
            self.views.annotationModal.show({
              model: annoModel,
              userModel: self.models.userModel,
              qcFlagsModel: self.models.qcFlagsModel,
              showUpdate: false
            });
          }

        });

        this.listenTo(this, 'ooi:downloadPlot', function() {
          //self.views.svgplot.download();
        });

        this.listenTo(this, 'StreamDownloadFormView:resetSubscriptionCollection', function() {
          self.collections.subscriptionCollection.fetch({ reset: true });
        });

        this.listenTo(this, 'ooi:downloadData', function() {
        });

        this.listenTo(this, "LargeDataCollection:updated", function(details){
          updateDownloadPagination(details);
        });

        this.listenTo(this, 'GetLargeFormatFiles:fetch',function(options){
          updateDownloadCollection(options);
        });

        this.listenTo(this, 'LargeFormatFileTable:update',function(options){
          var onErrorHandler = function(collection, response, options) {
            self.views.largeFileFormatView.showError(response.responseText);
            var details = {startAt: 0,
              count: 1,
              total: 0
            };
            updateDownloadPagination(details);
          };

          $.when(this.collections.largeFormatFiles.fetch({data : options, reset: true, error: onErrorHandler})).done(function() {
            self.views.largeFileFormatView.render();
          });
        });

        this.listenTo(this, 'DownloadModal:onSuccess',function(url, timeCalculation){
          self.views.modalDownloadView.show(url, timeCalculation);
        });

        this.listenTo(this, 'DownloadModalFail:onFail',function(msg){
          self.views.modalDownloadFailView.show(msg);
        });



      }
    });

    var ooi = new OOI();
    var collection = ooi.collections.streams;

    var vent = _.extend({}, Backbone.Events);
    var vobj = {};
    // controller for our model collections
    var streamCollection    = new StreamCollection();
    var arrayCollection     = new ArrayCollection();

    var instrumentFilter = {groupOp:"OR",rules:[]};
    var arrayFilter = {groupOp:"OR",rules:[]};
    var streamFilter = {groupOp:"OR",rules:[]};
    var platformFilter = {groupOp:"OR",rules:[]};
    var nodeFilter = {groupOp:"OR",rules:[]};
    var timeRangeFilter = {groupOp:"OR",rules:[]};
    var depthRangeFilter = {groupOp:"OR",rules:[]};
    var mobileAssetFilter = {field: "platform_name", op: "cn", data: ""};
    var engInstrumentFilter = {field: "stream_name", op: "nc", data: "-eng"};
    var metadataStreamFilter = {field: "stream_name", op: "nc", data: "metadata"};
    var statusStreamFilter = {field: "stream_name", op: "nc", data: "status"};
    var invalidatedStreamFilter = {field: "stream_name", op: "bn", data: "bad"};
    var instrumentStreamFilter = {field: "stream_dataset", op: "nc", data: "-eng"};
{#    var filterToolbarFilter = {groupOp:"AND",rules:[]};#}
    var globalFilter = null;

    var defaultPlotTypes = new DefaultPlotCollection();

    // url arguments
    var data = {};
    // begin the iterative fetching of arrays, assets, and streams.
{#    var streamFetch = streamCollection.fetch({ reset: true });#}
{#    var defaultPlotFetch = defaultPlotTypes.fetch({ reset: true });#}

    // Sets up the action buttons in the jqGrid table
    var createActionButtons = function(cellvalue, options, rowObject){
      var currentUser = null;
      if(ooi.login.loggedIn()) {
        currentUser = ooi.models.userModel.attributes;
      }

      var actionButtons = "<div style='display: flex;justify-content: space-between;'>";

      // Add stream to plot button
      if(_.isNull(rowObject.stream_name)) {
        actionButtons += "<button type='button' title='Plot' style='float:left' id='goPlot' class='btn btn-default instrument-to-plot' disabled><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i></button>";
      }else{
         actionButtons += "<button type='button' title='Plot' style='float:left' id='goPlot' class='btn btn-default instrument-to-plot'><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-plus-square' aria-hidden='true'></i></button>";
      }

      // Download Data Button
      if(!_.isNull(rowObject.stream_name) && ooi.login.loggedIn()) {
        actionButtons += "<button type='button' title='Download' style='float:left' id='goDownload' class='btn btn-default' onclick=\"openDownload('" + rowObject.ref_des + "','" + rowObject.stream_name + "',null);\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-download' aria-hidden='true'></i></button>";
      }else{
        actionButtons += "<button type='button' title='Download' style='float:left' id='goDownload' class='btn btn-default' onclick=\"openDownload('" + rowObject.ref_des + "','" + rowObject.stream_name + "',null);\" disabled><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-download' aria-hidden='true'></i></button>";
      }

      // Asset management button
      actionButtons += "<button type='button' title='Asset Management' style='float:left' id='goAssetManagement' class='btn btn-default' onclick=\"openAssetManagement('" + rowObject.ref_des + "','" + rowObject.stream_name + "');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-sitemap' aria-hidden='true'></i></button>";

      // IRIS Link
      if(rowObject.iris_enabled || rowObject.rds_enabled) {
        actionButtons += "<button type='button' title='Access External Data' style='float:left' id='goDownload' class='btn btn-default' onclick=\"openExternalDownload('" + rowObject.ref_des + "','" + rowObject.stream_name + "','" + rowObject.iris_link + "','" + rowObject.iris_enabled + "','" + rowObject.rds_link + "','" + rowObject.rds_enabled + "',null);\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-external-link' aria-hidden='true'></i></button>";
      }else{
        actionButtons += "<button type='button' title='Access External Data' style='float:left' id='goDownload' class='btn btn-default' onclick=\"openExternalDownload('" + rowObject.ref_des + "','" + rowObject.stream_name + "','" + rowObject.iris_link + "','" + rowObject.iris_enabled + "','" + rowObject.rds_link + "','" + rowObject.rds_enabled + "',null);\" disabled><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-external-link' aria-hidden='true'></i></button>";
      }


      actionButtons += "</div>";
      return actionButtons;
    };

    // Opens the download modal
    var openDownload = function(ref_des, stream_name, dtRange) {
      var dlModel = collection.where({ref_des:ref_des,stream_name:stream_name})[0];
{#      console.log(self.models.userModel.get("email"));#}
{#      dlModel.attributes.email = self.models.userModel.get("email");#}
      dlModel.attributes.hideTimeRange = false;
      if(dtRange === null){
        dlModel.attributes.startDate = null;
        dlModel.attributes.endDate = null;
      }else{
        dlModel.attributes.hideTimeRange = true;
        dlModel.attributes.startDate = dtRange['startDate'];
        dlModel.attributes.endDate = dtRange['endDate'];
      }

      //console.log(dlModel);
      ooi.trigger('StreamTableItemView:onClick', {model: dlModel});
    };

    // Hides the IRIS modal after clicking the link
    var hideModal = function() {
      $('button.close').click();
    };

    // Opens the external link download
    var openExternalDownload = function(ref_des, stream_name, iris_link, iris_enabled, rds_link, rds_enabled) {
      var daWarning = new ModalDialogView();

      // console.log([ref_des, stream_name, iris_link, iris_enabled, rds_link, rds_enabled]);

      var message = "";

      if(rds_enabled === "true") {
        var theRDSMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
        theRDSMessage += '<div style="width=100%;margin-top:15px;"><p><img src="/img/logos-banners/OOI_Logo.svg" alt="OOI" height="100"></p></div>';
        theRDSMessage += "You are about to navigate to the OOI raw data server.";
        theRDSMessage += "<p><a id='rds_link_message' onClick='parent.hideModal();' target='_blank' href='" + rds_link + "'>Click Here to Proceed</a></p>";
        theRDSMessage += "</div>";
        message += theRDSMessage
      }

      if(iris_enabled === "true") {
        var theIrisMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
        theIrisMessage += '<div style="background-color:#4D3493;width=100%;margin-top:15px;"><p><img src="/img/logos-banners/iris_logo_shadow.png" alt="IRIS" height="65"></p></div>';
        theIrisMessage += "You are about to navigate to an external website operated by IRIS.";
        theIrisMessage += "<p><a id='iris_link_message' onClick='parent.hideModal();' target='_blank' href='" + iris_link + "'>Click Here to Proceed</a></p>";
        theIrisMessage += "</div>";
        message += theIrisMessage;
      }

      daWarning.show({
        message: message,
        type: "warning"
      });
    };

{#    // Opens the IRIS external link download
    var openRawDownload = function(ref_des, stream_name, rds_link, dtRange) {
      var daWarning = new ModalDialogView();

      var theMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
      theMessage += '<div style="width=100%;margin-top:15px;"><p><img src="/img/logos-banners/OOI_Logo.svg" alt="OOI" height="100"></p></div>';
      theMessage += "You are about to navigate to an external OOI-operated raw data server.";
      theMessage += "<p><a id='rds_link_message' onClick='parent.hideModal();' target='_blank' href='" + rds_link + "'>Click Here to Proceed</a></p>";
      theMessage += "</div>";
      daWarning.show({
        message: theMessage,
        type: "warning"
      });
    };#}

    var openAssetManagement = function(ref_des, stream_name) {
      //assets/list/#CE01ISSP
      location.origin = location.protocol + "//" + location.host;
      var win = window.open(location.origin+"/assets/management/#"+ref_des, '_blank');
      win.focus();
    };

    // Colors the end time
    var colorTime = function(cellvalue, options, rowObject) {
      var currentDate = new Date();
      var endDate = new Date(cellvalue);
      var timeSinceEndDate = currentDate.getTime()-endDate.getTime();

      // Base cell output is no background
      var cellOutput = '<i>'+cellvalue+'</i>';
      if(timeSinceEndDate <= 1000*60*60*12 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twelve-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate < 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twenty-four-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate >= 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="older">'+cellvalue+'</i>';
      }
      return cellOutput;
    };

    var depthFormatter = function(cellvalue, options, rowObject) {
      if(!$.isNumeric(cellvalue) || cellvalue === null || cellvalue === "" || _.isUndefined(cellvalue)){
        return undefined;
      }else{
        return cellvalue;
      }
    };

    // Formatter to fix stream_name to be usable by M2M
    var streamNameFormatter = function(cellvalue, options, rowObject) {
      if(cellvalue){
        return cellvalue.split('_')[1].replace(/-/g,'_')
      }else{
        return ""
      }
    };

    // Formatter to fix stream_name to be usable by M2M
    var streamNameUnFormatter = function(cellvalue, options, rowObject) {
      if(cellvalue){
        var stream_method = $dcGrid.getCell(options.rowId,"stream_method");
        //console.log(stream_method);
        return stream_method+"_"+cellvalue.replace(/_/g,'-')
      }else{
        return ""
      }
    };


    $.urlParam = function(name){
      var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
      if (results==null){
        return null;
      }
      else{
        return results[1] || 0;
      }
    };

    $(document).ready(function() {
      //input
      if(location.hash != ""){
        _.extend(vobj, {hash: location.hash.split('#')[1]});
      }else{
        _.extend(vobj, {hash: ""});
      }

      //console.log('location.hash document.ready');
      //console.log(location.hash);

      $('.update-plot').on('click', function(event){
        origStartDate = null;
        origEndDate = null;
        event.preventDefault();
        ooi.trigger('update_plot',{});
      });

      $('.zoom-update-plot').on('click', function(event){
        event.preventDefault();
        ooi.trigger('update_plot',{});
        $('.zoom-update-plot').prop('disabled',true);
        $('.zoom-update-plot').hide();
        $('#zoom-coordinates').empty();
        $('#update-plot').show();
      });

      $('#zoom-reset-plot').on('click', function(event) {
        event.preventDefault();
        $('#plot-view').empty();
        //console.log('zoom-reset-plot');
        //console.log(origStartDate);
        //console.log(origEndDate);
        ooi.trigger('updateCalendarZoom', {startDate: origStartDate, endDate: origEndDate});
        ooi.trigger('update_plot');
        origStartDate = null;
        origEndDate = null;
        $('.zoom-reset-plot').prop('disabled',true);
        $('.zoom-reset-plot').hide();
        $('#zoom-coordinates').empty();
      });

      $('.download-plot-data').on('click', function(event){
        event.preventDefault();
        ooi.trigger('download_plot_data',{});
      });

      $('.clear-plot-area').on('click', function(event){
        event.preventDefault();
        ooi.trigger('clear_plot_area',{});
      });

      $('input#showAdditionalParameters:checkbox').on('change', function(event){
        ooi.trigger('show_additional_parameters');
      });

      $('#reset_catalog_button').on('click', function(event){
        event.preventDefault();
        ooi.trigger('reset_catalog_list',{});
        $('.instrument-to-plot i.fa-minus-square').removeClass('fa-minus-square').addClass('fa-plus-square');
        $('#plot-view').html('<img src="/img/plotting/graph.png" style="height:400px;width:100%;">');
      });

      $('.clear-anno-info').on('click', function(event){
        event.preventDefault();
        $('#annotationInfo').html('<h5 style="font-size: 14px;float: left;padding-left: 5px;"><b>Click annotation on plot for description...</b></h5>');
        $('#clearAnnotationInfo').hide();
      });

      $('#clearAnnotationInfo').hide();

      ooi.start();

      updateCollection( showStreams );

      var searchSidebarView = new SearchSidebarView({el: '.search-sidebar', collection: streamCollection});
      searchSidebarView.render();
      searchSidebarView.renderFilterInput();

      $.fn.bootstrapSwitch.defaults.size = 'small';

      $("#InstrumentStreamSwitch").bootstrapSwitch('state', false);
      $("#EngInstrumentSwitch").bootstrapSwitch('state', false);
      $("#MetadataStreamSwitch").bootstrapSwitch('state', false);
      $("#StatusStreamSwitch").bootstrapSwitch('state', false);
      $("#InvalidatedStreamSwitch").bootstrapSwitch('state', false);
      $("#MobileAssetSwitch").bootstrapSwitch('state', false);
      $("#AllTimesSwitch").bootstrapSwitch('state', true);
      $("#AllDepthsSwitch").bootstrapSwitch('state', true);

      $.fn.scrollBottom = function(scroll){
        if(typeof scroll === 'number'){
          window.scrollTo(0,$(document).height() - $(window).height() - scroll);
          return $(document).height() - $(window).height() - scroll;
        } else {
          return $(document).height() - $(window).height() - $(window).scrollTop();
        }
      };

      var amountScrolled = 200;

      $(window).scroll(function() {
        if ( $(window).scrollTop() > amountScrolled) {
          $('a.back-to-top').fadeIn('slow');
{#          $('a.back-to-bottom').fadeIn('slow');#}
        } else {
          $('a.back-to-top').fadeOut('slow');
{#          $('a.back-to-bottom').fadeOut('slow');#}
        }

        if ( $(window).scrollBottom() > amountScrolled ) {
{#          $('a.back-to-top').fadeIn('slow');#}
          $('a.back-to-bottom').fadeIn('slow');
        } else {
{#          $('a.back-to-top').fadeOut('slow');#}
          $('a.back-to-bottom').fadeOut('slow');
        }
      });

      $('a.back-to-top').click(function() {
        $('html, body').animate({
          scrollTop: 0
        }, 700);
        return false;
      });

      $('a.back-to-bottom').click(function() {
        $('html, body').animate({
          scrollTop: $(document).height()
        }, 700);
        return false;
      });

      // Fixs the jqGrid tab width based on current window size
      var fixjqGridSize = function() {
        var jqGridWrapperId = "#gbox_" + $dcGrid.attr('id'); //here be dragons, this is     generated by jqGrid.
        $dcGrid.setGridWidth($(jqGridWrapperId).parent().width()-20); //perhaps add padding calculation here?
      };

      // Fix the sidebar filter size and jqGrid width on window/browser resize
      $(window).resize(function () {
        // console.log('setting new grid width');
        fixjqGridSize();
        // Fix scrollable height of filters after DA is added
        $('#filterScrollContainer').height(jQuery('#plottingBodyContainer').height());
        {#$('#filterScrollContainer').css({
          "height": "calc(100vh - 165px)",
          "overflow-y": "scroll"
        })#}
      });

      $('#navGrid select').change(function() {
        $('#filterScrollContainer').height(jQuery('#plottingBodyContainer').height());
      });

      // Fix the jqGrid width after tab selection
      $( 'a[data-toggle="tab"]' ).on( 'shown.bs.tab', function( evt ) {
        // console.log('shown.bs.tab');
        fixjqGridSize()
      });

{#      $(window).load(function(){
        $('#filterScrollContainer').css({
          "height": "calc(100vh - 165px)",
          "overflow-y": "scroll"
        })
      });#}

      $('#EngInstrumentSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateEng = $("#EngInstrumentSwitch").bootstrapSwitch('state');
        if (theStateEng) {
          engInstrumentFilter = {field: "stream_name", op: "cn", data: ""};
        } else {
          engInstrumentFilter = {field: "stream_name", op: "nc", data: "-eng"};
        }
        combineFilters();
      });

      $('#MetadataStreamSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateMeta = $("#MetadataStreamSwitch").bootstrapSwitch('state');
        if (theStateMeta) {
          metadataStreamFilter = {field: "stream_name", op: "cn", data: ""};
        } else {
          metadataStreamFilter = {field: "stream_name", op: "nc", data: "metadata"};
        }
        combineFilters();
      });

      $('#StatusStreamSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateStatus = $("#StatusStreamSwitch").bootstrapSwitch('state');
        if (theStateStatus) {
          statusStreamFilter = {field: "stream_name", op: "cn", data: ""};
        } else {
          statusStreamFilter = {field: "stream_name", op: "nc", data: "status"};
        }
        combineFilters();
      });

      $('#InvalidatedStreamSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateInvalidated = $("#InvalidatedStreamSwitch").bootstrapSwitch('state');
        if (theStateInvalidated) {
          invalidatedStreamFilter = {field: "stream_name", op: "bw", data: "bad"};
        } else {
          invalidatedStreamFilter = {field: "stream_name", op: "bn", data: "bad"};
        }
        combineFilters();
      });

      $('#MobileAssetSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateMobile = $("#MobileAssetSwitch").bootstrapSwitch('state');
        if (theStateMobile) {
          mobileAssetFilter = {field: "platform_name", op: "cn", data: "Mobile Asset"};
        } else {
          mobileAssetFilter = {field: "platform_name", op: "cn", data: ""};
        }
        combineFilters();
      });

      $('#AllTimesSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateAllTimes = $("#AllTimesSwitch").bootstrapSwitch('state');
        var options = {};

        if (!theStateAllTimes) {
          options.min = new Date('1900', '00', '01');
          options.max = new Date('3000', '00', '01');
          $('#timeRangeFilterContainer').hide();
        } else {
          options.min = new Date('2013', '00', '01');
          options.max = new Date();
          var timeSlider = $('#slider');

          options.min = timeSlider.dateRangeSlider("min");
          options.max = timeSlider.dateRangeSlider("max");
          $('#timeRangeFilterContainer').show();
        }
        var startDate = new Date(options.min).toISOString(),
          endDate   = new Date(options.max).toISOString();

        setTimeRangeFilter("start", startDate, "end", endDate);
        combineFilters();
      });

      $('#AllDepthsSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateAllDepths = $("#AllDepthsSwitch").bootstrapSwitch('state');
        var options = {};

        if (!theStateAllDepths) {
          options.min = -10;
          options.max = 4500;
          $('#depthRangeFilterContainer').hide();
        } else {

          var depthSlider = $('#depth-slider');

          options.min = depthSlider.rangeSlider("min");
          options.max = depthSlider.rangeSlider("max");
          $('#depthRangeFilterContainer').show();
        }

        ooi.trigger("DepthRangeFilterView:change", options);
      });

      $('#InstrumentStreamSwitch').on('switchChange.bootstrapSwitch', function () {
        var theStateInst = $("#InstrumentStreamSwitch").bootstrapSwitch('state');
        if (theStateInst) {
          instrumentStreamFilter = {field: "stream_dataset", op: "cn", data: ""};
        } else {
          instrumentStreamFilter = {field: "stream_dataset", op: "cn", data: "Instrument"};
        }
        combineFilters();
      });
{#      console.log('document.ready complete');#}
    });

    var setArrayButtonState = function(){
      var arrays = getUniqueNames('array_name');
      $.each (arrays, function() {
        $.find('button[title=\"'+this+'\"]')[0].disabled = false;
      });
    };

    var setScienceFilter = function(searchColumn, searchParam){
      var searchFilter = searchParam, grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      f.rules.push({field:searchColumn,op:"cn",data:searchFilter});
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var resetTimeFilter = function() {
      var timeSlider = $('#slider');

      var newOptions = {};
      newOptions.min = new Date('2013', '00', '01');
      newOptions.max = new Date(Date.now());

      timeSlider.dateRangeSlider("bounds", newOptions);
      timeSlider.dateRangeSlider("values", newOptions);
      timeSlider.dateRangeSlider("min", new Date('2013', '00', '01'));
      timeSlider.dateRangeSlider("max", new Date(Date.now()));
      timeSlider.dateRangeSlider("resize");

      timeRangeFilter = {groupOp:"OR",rules:[]};
      combineFilters();
    };

    var resetDepthFilter = function() {
      var depthSlider = $('#depth-slider');

      var newOptions = {};
      newOptions.min = -10;
      newOptions.max = 4500;

      depthSlider.rangeSlider("bounds", newOptions);
      depthSlider.rangeSlider("values", newOptions.min, newOptions.max);
      depthSlider.rangeSlider("min", newOptions.min);
      depthSlider.rangeSlider("max", newOptions.max);
      depthSlider.rangeSlider("resize");

      $('#manualDepthRangeMin').val(newOptions.min);
      $('#manualDepthRangeMax').val(newOptions.max);

      setDepthRangeFilter("depth", newOptions.min, newOptions.max);
      
      depthRangeFilter = {groupOp:"OR",rules:[]};
      combineFilters();
    };

    var resetAllFilters = function() {
      $("#resetAllFilters").blur();
      {#      $('input:checkbox').removeAttr('checked');#}
      $('input:checkbox').prop('checked', false);
      $("#globalSearchText").val("");
      $("#EngInstrumentSwitch").bootstrapSwitch('state', false);
      $("#MetadataStreamSwitch").bootstrapSwitch('state', false);
      $("#StatusStreamSwitch").bootstrapSwitch('state', false);
      $("#InvalidatedStreamSwitch").bootstrapSwitch('state', false);
      $("#MobileAssetSwitch").bootstrapSwitch('state', false);
      $("#AllTimesSwitch").bootstrapSwitch('state', false);
      $("#AllDepthsSwitch").bootstrapSwitch('state', false);
{#      $dcGrid[0].clearToolbar();#}
      instrumentFilter = {groupOp:"OR",rules:[]};
      arrayFilter = {groupOp:"OR",rules:[]};
      streamFilter = {groupOp:"OR",rules:[]};
      platformFilter = {groupOp:"OR",rules:[]};
      nodeFilter = {groupOp:"OR",rules:[]};
      timeRangeFilter = {groupOp:"OR",rules:[]};
      depthRangeFilter = {groupOp:"OR",rules:[]};
      mobileAssetFilter = {field: "platform_name", op: "cn", data: ""};
      engInstrumentFilter = {field:"stream_name",op:"nc",data:"-eng"};
      metadataStreamFilter = {field:"stream_name",op:"nc",data:"metadata"};
      statusStreamFilter = {field:"stream_name",op:"nc",data:"status"};
      invalidatedStreamFilter = {field:"stream_name",op:"bn",data:"bad"};
      instrumentStreamFilter = {field:"stream_dataset",op:"nc",data:"Instrument"};
{#      filterToolbarFilter = {groupOp:"AND",rules:[]};#}
      globalFilter = null;
      location.href = location.href.substring(0, location.href.indexOf('?'));
      location.hash = "";
      var newOptions = {};
      newOptions.min = new Date('2013', '00', '01');
      newOptions.max = new Date();
      var depthOptions = {};
      depthOptions.min = -10;
      depthOptions.max = 4500;
      ooi.trigger("TimeRangeFilterView:addToTimeRange", newOptions);
      ooi.trigger("DepthRangeFilterView:change", depthOptions);
      combineFilters();
      $('#filterScrollContainer').height(jQuery('#plottingBodyContainer').height());
    };

    var setArrayFilter = function(searchColumn, searchParam){
      searchParam = searchParam + "";

      var searchFilter = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFilter, function() {
        f.rules.push({field:searchColumn,op:"bw",data:this});
      });
      arrayFilter = f;
      {#      grid[0].p.search = true;#}
      {#      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});#}
      {#      grid.trigger("reloadGrid",[{page:1,current:true}]);#}
    };

    var showCurrentFilters = function() {
      //console.log($dcGrid.getGridParam("postData").filters);
    };

    var setInstrumentFilter = function(searchColumn, searchParam){
      searchParam = searchParam + "";

      var searchFilter = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFilter, function() {
        f.rules.push({field:searchColumn,op:"cn",data:this});
      });
      instrumentFilter = f;
    };

    var setStreamFilter = function(searchColumn, searchParam){
      searchParam = searchParam + "";

      var searchFilter = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFilter, function() {
        f.rules.push({field:searchColumn,op:"cn",data:this});
      });
      streamFilter = f;
    };

    var setPlatformFilter = function(searchColumn, searchParam){
      searchParam = searchParam + "";

      var searchFilter = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFilter, function() {
        f.rules.push({field:searchColumn,op:"cn",data:this});
      });
      platformFilter = f;
    };

    var setNodeFilter = function(searchColumn, searchParam){
      searchParam = searchParam + "";

      var searchFilter = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFilter.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFilter, function() {
        f.rules.push({field:searchColumn,op:"cn",data:this});
      });
      nodeFilter = f;
    };

    var setTimeRangeFilter = function(start, startTime, end, endTime){
      timeRangeFilter = {groupOp:"AND",rules:[{field:start,op:"le",data:endTime},{field:end,op:"ge",data:startTime}]};
    };

    var setDepthRangeFilter = function(depthField, startDepth, endDepth){
      //console.log('setDepthRangeFilter');
      if(startDepth == -10 && endDepth == 4500){
        depthRangeFilter = {groupOp:"OR",rules:[]};
      }else{
        depthRangeFilter = {groupOp:"AND",rules:[{field:depthField,op:"le",data:endDepth},{field:depthField,op:"ge",data:startDepth}]};
      }

      combineFilters();
    };

    var combineFilters = function() {
      var allFilters = [];
      allFilters.push(arrayFilter);
      allFilters.push(instrumentFilter);
      allFilters.push(streamFilter);
      allFilters.push(platformFilter);
      allFilters.push(nodeFilter);
      allFilters.push(timeRangeFilter);
      allFilters.push(depthRangeFilter);
{#      allFilters.push(filterToolbarFilter);#}

      var combinedFilters = {
        groupOp:"AND",
        rules:[],
        groups:allFilters
      };

      // Toggle Filters
      var aaa = {groupOp:"AND", rules:[]};
      aaa.rules.push(mobileAssetFilter);
      aaa.rules.push(engInstrumentFilter);
      aaa.rules.push(metadataStreamFilter);
      aaa.rules.push(statusStreamFilter);
      aaa.rules.push(invalidatedStreamFilter);
      aaa.rules.push(instrumentStreamFilter);
      combinedFilters.groups.push(aaa);

      {#      // Toggle Filters#}
      {#      var bbb = {groupOp:"OR", rules:[]};#}
      {#      #}
      {#      combinedFilters.groups.push(bbb);#}

      // Global filter
      var ggg = {groupOp:"OR", rules:[], groups:[]};
      if(globalFilter != null){
        //console.log(globalFilter);
        $.each(globalFilter, function() {
          $.each(this, function() {
            ggg.groups.push(this);
          });

          combinedFilters.groups.push(ggg);
          ggg = {groupOp:"OR", rules:[], groups:[]};
        });
      }

      // Ensure $dcGrid is defined (page load race conditions) before attempting to set filters
      if (!_.isUndefined($dcGrid[0].p)) {
        $dcGrid[0].p.search = true;
        $.extend($dcGrid[0].p.postData,{filters:JSON.stringify(combinedFilters)});
        $dcGrid.trigger("reloadGrid",[{page:1,current:true}]);
      }
    };

    var numberTemplate = {
      formatter : 'number',
      align : 'right',
      sorttype : 'number',
      editable : true,
      searchoptions : { sopt : ['eq', 'ne', 'lt', 'le', 'gt', 'ge', 'nu', 'nn', 'in', 'ni'] }
    };

    var defaultFilters = {
      "groupOp" : "AND",
      "rules" : [
        { "field" : "All", "op" : "cn", "data" : ""}
      ]
    };

    var $dcGrid = $("#grid");

    var getUniqueNames = function(columnName) {
        var texts = $dcGrid[0].p.data, uniqueTexts = [],
          textsLength = texts.length, text, textsMap = {}, i;
        for (i=0;i<textsLength;i++) {
          text = texts[i][columnName];
          if (text !== undefined && textsMap[text] === undefined) {
            // to test whether the texts is unique we place it in the map.
            textsMap[text] = true;
            uniqueTexts.push(text);
          }
        }
        return uniqueTexts;
      },
      buildSearchSelect = function(uniqueNames) {
        var values=":All";
        $.each (uniqueNames, function() {
          values += ";" + this + ":" + this;
        });
        return values;
      },
      setSearchSelect = function(columnName) {
        $dcGrid.jqGrid('setColProp', columnName,
          {
            stype: 'select',
            searchoptions: {
              value:buildSearchSelect(getUniqueNames(columnName)),
              sopt:['eq']
            }
          }
        );
      };

    var highlightFilteredData = function () {
      var $self = $(this), filters, i, l, rules, rule, iCol,
        isFiltered = $self.jqGrid("getGridParam", "search"),
        postData = $self.jqGrid("getGridParam", "postData"),
        colModel = $self.jqGrid("getGridParam", "colModel"),
        colIndexByName = {};

      // validate whether we have input for highlighting
      if (!isFiltered || typeof postData !== "object") {
        return;
      }
      filters = $.parseJSON(postData.filters);
      if (filters == null || filters.rules == null || filters.rules.length <= 0) {
        return;
      }

      // fill colIndexByName which get easy column index by the column name
      for (i = 0, l = colModel.length; i < l; i++) {
        colIndexByName[colModel[i].name] = i;
      }

      rules = filters.rules;
      for (i = 0, l = rules.length; i < l; i++) {
        rule = rules[i];
        iCol = colIndexByName[rule.field];
        if (iCol !== undefined) {
          $self.find(">tbody>tr.jqgrow>td:nth-child(" + (iCol + 1) + ")").highlight(rule.data);
        }
      }
    };

    // Loads the jqGrid into
    function placeJqGrid(collection, dataAvailabilityCollection) {
      $dcGrid.jqGrid({
        onCellSelect: function(row, col, content, event){
          var selectedRow = $dcGrid.getRowData(row);
          var modelList = collection.where({'ref_des': selectedRow.reference_designator,'stream_name':selectedRow.stream_name});
          var $evt = $(event.target);

          // Toggle for add/remove stream from plotting list
          // Check is start and end times are exactly the same, if so send message to user and don't so it
          if (selectedRow.start != selectedRow.end) {
            if ($evt.find('i').hasClass('fa-plus-square')) {
              if (!_.isUndefined(modelList) && modelList.length > 0) {
                //trigger for a new plot item
                // if(ooi.collections.selectedStreamCollection.length == 0) {
                  ooi.trigger('add_catalog_model', {model: modelList[0], evt: $evt});
                  $evt.find('i').removeClass('fa-plus-square').addClass('fa-minus-square')
                // }else{
                  // var interpWarning = new ModalDialogView();
                  // var interpWarningMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
                  // interpWarningMessage += "<p>Sorry, currently unable to add second stream.</p>";
                  // interpWarningMessage += "<p>Interpolated plotting is offline.</p>";
                  // interpWarningMessage += "</div>";
                  // interpWarning.show({
                    // message: interpWarningMessage,
                    // type: "warning"
                  // });
                // }
              }
            } else {
              if ($evt.find('i').hasClass('fa-minus-square')) {
                if (!_.isUndefined(modelList) && modelList.length > 0) {
                  //trigger a remove for a model
                  ooi.trigger('remove_catalog_model', {model: modelList[0]});
                  $evt.find('i').removeClass('fa-minus-square').addClass('fa-plus-square')
                }
              }
            }
          }else{
            var daWarning = new ModalDialogView();
            var theMessage = "<div style='font-size: 16px;text-align:center;padding-top: 10px;'>";
            theMessage += "<p>Sorry, currently unable to plot this stream.  Start and end times are exactly the same.</p>";
            theMessage += "<p>Start Time: " + selectedRow.start + "</p>";
            theMessage += "<p>End Time: " + selectedRow.end + "</p>";
            theMessage += "</div>";
            daWarning.show({
              message: theMessage,
              type: "warning"
            });
          }

{#          // Show Data Availability Pop-up
          $("#dataAvailability").empty();
          $("#dataAvailabilityInfo").empty();
          // Use this for the dataAvailabilityCollection
          $("#dataAvailabilityInfo").append("[Mocked] Currently viewing data availability for: " + selectedRow.reference_designator);
          //console.log('dataAvailabilityCollection');
          //console.log(dataAvailabilityCollection);
          stats_data = dataAvailabilityCollection.models[0].attributes['stats_data'];
          moment.locale("en");
          var dataset=[];
          if (stats_data['operational_status'].length>0) {
            dataset.push({
              "measure": "Op. Status",
              "interval_s": 30 * 24 * 60 * 60,
              "data": stats_data['operational_status']
            })
          }
          if (stats_data['cassandra_ts'].length>0) {
            dataset.push({
              "measure": "Cass. Tel/Stream",
              "interval_s": 30 * 24 * 60 * 60,
              "data": stats_data['cassandra_ts']
            })
          }
          if (stats_data['cassandra_rec'].length>0) {
            dataset.push({
              "measure": "Cass. Recovered",
              "interval_s": 30 * 24 * 60 * 60,
              "data": stats_data['cassandra_rec']
            })
          }

          var chart = visavailChart().width(800); // define width of chart in px

          d3.select("#dataAvailability")
            .datum(dataset)
            .call(chart);#}

          // Fix scrollable height of filters after DA is added
          {#$('#filterScrollContainer').css({
            "height": "calc(100vh - 165px)",
            "overflow-y": "scroll"
          })#}
        },
        datatype : "local",
        data : collection.toJSON(),
        colNames: [
          'Actions',
          'Array',
          {#          'Site Name',#}
          'Platform Name',
          'Node',
          'Instrument',
          'Start Time',
          'End Time',
          'Stream Type',
          'Delivery Method',
          'Stream Content',
          'Deployment Depth',
          'Water Depth',
          'Latitude',
          'Longitude',
          'Reference Designator',
          'Stream Identifier',
          'Unique ID',
          'IRIS Link',
          'IRIS Enabled',
          'RDS Link',
          'RDS Enabled'
        ],

        colModel : [
          { name : 'actions',
            caption : 'Plot/Download',
            width : 140,
            sortable : false,
            search : false,
            align : 'center',
            formatter : createActionButtons
          },
          {
            name : 'array_name',
            index : 'array_name',
            editable : false,
            {#                width : 100,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {#          {#}
          {#            name : 'site_name',#}
          {#            index : 'site_name',#}
          {#            editable : false,#}
          {#                width : 150,#}
          {#            sortable : true,#}
          {#            sorttype : 'string',#}
          {#            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},#}
          {#            align : 'center',#}
          {#            unformat : function (cellvalue, options, cell) {#}
          {#              return $('input', cell).val() || cellvalue;#}
          {#            }#}
          {#          },#}
          {
            name : 'platform_name',
            index : 'platform_name',
            editable : false,
            {#                width : 150,#}
            sortable : true,
            search : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assembly_name',
            index : 'assembly_name',
            editable : false,
            {#                width : 150,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'display_name',
            index : 'display_name',
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            editable : false,
            {#                width : 150,#}
            sortable : true,
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'start',
            index : 'start',
            editable : false,
            width : 160,
            sortable : true,
            sorttype : 'date',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'end',
            index : 'end',
            editable : false,
            width : 160,
            sortable : true,
            sorttype : 'date',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            formatter : colorTime,
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
            {#            cellattr: function(rowId, val, rawObject, cm, rdata) { colorTime(rowId, val, rawObject, cm, rdata); }#}
          },
          {
            name : 'stream_dataset',
            index : 'stream_dataset',
            editable : false,
            hidden: false,
            {#                width : 85,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'stream_method',
            index : 'stream_method',
            editable : false,
            hidden: false,
            {#                width : 85,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'stream_display_name',
            index : 'stream_display_name',
            editable : false,
            hidden: false,
            {#                width : 85,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'depth',
            index : 'depth',
            width : 85,
            editable : false,
            sortable : true,
            sorttype : 'number',
            formatter : depthFormatter,
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'water_depth',
            index : 'water_depth',
            hidden: true,
            editable : false,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'latitude',
            index : 'latitude',
            editable : false,
            width : 85,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'longitude',
            index : 'longitude',
            editable : false,
            width : 85,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'reference_designator',
            index: 'reference_designator',
            key: false, // rowID = reference_designator
            editable: false,
            width: 195,
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'stream_name',
            index : 'stream_name',
            {#            key : true,#}
            editable : false,
            hidden : false,
            {#                width : 85,#}
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            formatter : streamNameFormatter,
            {#unformat : function (cellvalue, options, cell) {
              console.log(cellvalue);
              console.log(options);
              console.log(cell);
              return $('input', cell).val() || cellvalue;
            }#}
            unformat : streamNameUnFormatter
          },
          {
            name : 'unique_id',
            index : 'unique_id',
            key : true, // rowID = unique_id = ref_des+stream_name
            hidden : true,
            editable : false,
            {#                width : 165,#}
            sortable : false,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'iris_link',
            index: 'iris_link',
            key: false,
            hidden : true,
            editable: false,
            {#                width: 165,#}
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'iris_enabled', // iris_link available, download off, plotting off
            index: 'iris_enabled',
            key: false,
            hidden : true,
            editable: false,
            {#                width: 165,#}
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'rds_link',
            index: 'rds_link',
            key: false,
            hidden : true,
            editable: false,
            {#                width: 165,#}
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name: 'rds_enabled',
            index: 'rds_enabled',
            key: false,
            hidden : true,
            editable: false,
            {#                width: 165,#}
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        ondblClickRow: function (id) {
          // alert("You double click row with id: " + id);
        },
        loadComplete : function(data) {
          highlightFilteredData.call($dcGrid);
{#          console.log('loadComplete');#}
          $("#navGrid").find("option[value=\"50000\"]").text('All');


{#          console.log(initialLocationSearch);#}
          if (initialLocationSearch != "") {
            navSearchParse(initialLocationSearch);
          }

          var jqGridWrapperId = "#gbox_" + $dcGrid.attr('id'); //here be dragons, this is     generated by jqGrid.
          $dcGrid.setGridWidth($(jqGridWrapperId).parent().width()-20); //perhaps add padding calculation here?
          $('#filterScrollContainer').height(jQuery('#plottingBodyContainer').height());
        },
        gridComplete : function() {
{#          console.log('gridComplete');#}
{#          console.log(initialLocationSearch);#}
{#          initialLocationSearch = "";#}
          $('#gbox_grid').css({
            "padding":"5px",
            "background-color":"#e9e9e9"
          })
        },
        beforeRequest : function() {
{#          console.log('beforeRequest');#}
{#          console.log(initialLocationSearch);#}

        },
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 15,
        rowList : [15, 30, 45, 60, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGrid',
        sortname : 'end',
        viewrecords : true,
        sortorder : 'desc',
        sortable : true,
        caption : 'Data Catalog',
        altRows: false,
        {#        altclass:'myAltRowClass',#}
        {#        classes: 'table table-bordered table-striped table-selectable',#}
        ignoreCase: true,
        shrinkToFit : false,
        multiselect: false,
        multiboxonly: false,
        reloadAfterSubmit : false,
        loadOnce : false,
{#        loadui: 'block',#}
        hidegrid : false
      }).jqGrid('navGrid',
        '#navGrid',
        {
          edit : false,
          add : false,
          del : false,
          refresh : false,
          search : true
          // beforeRefresh:
          // Set the latest data from collection before refreshing grid
          {#            beforeRefresh : function () {#}
          {#              $("#grid").jqGrid('setGridParam', {#}
          {#                datatype : 'local',#}
          {#                data : ooi.collections.streams.toJSON()#}
          {#              });#}
          {#            }#}
        },
        {},
        {},
        {},
        {
{#          cloneToTop : true,#}
          closeOnEscape : true,
          multipleSearch : true,
          multipleGroup : true,
{#          overlay: 0,#}
          width : 700,
          recreateForm:true,
          jqModal:true,
          onInitializeSearch: function ($form) {
            combineFilters();
          },
          beforeShowSearch: function($form) {
            return true;
          }
        });



      {#      $dcGrid.jqGrid('jqGridExport', {exptype: 'jsonstring', root: 'ooidatacatalog', ident: '\t'});#}

      $dcGrid.jqGrid('navButtonAdd', '#navGrid', {
        caption: "Column Changer",
        buttonicon: "ui-icon-calculator",
        title: "Column Changer",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{
            						width: 700,
            						dialog_opts: {
            							modal: true,
            							minWidth: 470,
{#            							height: 470,#}
            							show: 'blind',
            							hide: 'explode',
            							dividerLocation: 0.5
            						}
          });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              // alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              // alert('column "' + $(this).parent().text() + '" is chosen');
            });

        }
      });


      //setSearchSelect('array_name');

      {#      $dcGrid.jqGrid('setColProp', 'array_name',#}
      {#        {#}
      {#          searchoptions: {#}
      {#            sopt:['cn'],#}
      {#            dataInit: function(elem) {#}
      {#              $(elem).autocomplete({#}
      {#                source:getUniqueNames('array_name'),#}
      {#                delay:0,#}
      {#                minLength:0#}
      {#              });#}
      {#            }#}
      {#          }#}
      {#        });#}

{#      $dcGrid.jqGrid('filterToolbar',
        {
          autosearch : true,
          searchOperators : false,
          searchOnEnter : false,
          stringResult:true,
          #}{#          defaultSearch:"cn"#}{#
          afterClear : function() {
            combineFilters();
          },
          afterSearch : function() {
            filterToolbarFilter = JSON.parse($dcGrid.getGridParam("postData").filters);
            combineFilters()
          }
        }
      );#}

      if(location.hash!=""){
        //console.log('setArrayFilter');
        //console.log(location.hash.split('#')[1].substr(2));
{#        setArrayFilter('reference_designator', location.hash.split('#')[1].substr(2));#}
{#        combineFilters();#}
      }

      var performGlobalSearch = function(searchText) {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
{#          searchText = $("#globalSearchText").val(),#}
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        var textParts = {};
        for (k=0; k<cnParts; k++) {
          st = searchTextParts[k];
          textParts[st] = [];
          $.each(colModel, function() {
            var cm1 = this;
            if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
              textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
            }
          });
        }
        globalFilter = textParts;

        combineFilters();
      };

      // fill top toolbar
      var $grid = $dcGrid;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchText\">Global search in grid for:&nbsp;</label><input id=\"globalSearchText\" type=\"text\"></input>&nbsp;<button id=\"globalSearch\" type=\"button\">Search</button></div>"));
      $("#globalSearchText").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          initialLocationSearch = "";
          performGlobalSearch($("#globalSearchText").val());
        }
      });
      $("#globalSearch").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        initialLocationSearch = "";
          performGlobalSearch($("#globalSearchText").val());
      });

    } // placeJqGrid


    function placeDataAvailability(selectedStreamObj) {

      var ref_des = selectedStreamObj['ref_des'];
      var stream_name = selectedStreamObj['stream_name'];
      var dataset=[];
      var onDataHandler = function(collection, response, options) {

        // Show Data Availability Pop-up
        $("#data-vailability-dc").empty();

        dataset=[];

        collection.each(function(model){
          // console.log(model.get('data'));
          dataset.push({
            "measure_html": "<div style='width: 280px; text-align: right;'>"+model.get('measure')+"</div>",
            "categories": model.get('categories'),
            "data": model.get('data'),
            "interval_s": 365 * 24 * 60 * 60
          });
        }); // each chart in the collection

        draw_visavail(ref_des, stream_name);
      };

      var chart = visavailChart();
      function draw_visavail(ref_des, stream_name) {
        chart.width($('#visavail_container').width()-350);
        chart.marginLeft(300);
        chart.paddingLeft(-300);

        var divId = "div_" + ref_des + stream_name;
        // console.log(divId);
        $('#example').append('<div id="' + divId + '"></div>');
        d3.select("#"+divId)
          .datum(dataset)
          .call(chart);
        d3.selectAll("#"+divId+" svg #g_title .heading")
          .filter(function() {
            return /^Data/.test(d3.select(this).text());  // Check if text begin with a "C"
          })
          .text('Data Availability Plot ('+ ref_des + ')');
      }

{#      $(window).resize(function () { return draw_visavail(); });#}

      ooi.collections.dataAvailabilityCollection.fetch(
        {
          url: '/api/data_availability/'+ref_des,
          success : onDataHandler
        });

    }


    function showStreams( collection, response ){
      //jqGrid
      var jqCollection = collection;
      jqCollection['actions'] = '';
      // ooi.collections.dataAvailabilityCollection.fetch();
      //console.log(ooi.collections.dataAvailabilityCollection);
      placeJqGrid(jqCollection, ooi.collections.dataAvailabilityCollection);
      $('#reset_catalog_button').css('display','inline-block'); //TODO REMOVE LINE

      if (collection.length == 1){
        ooi.trigger('add_catalog_model',{model: collection.models[0]});
      }
      combineFilters();
    }


    function updateCollection( successCallback ){
      // console.log('updateCollection');
      collection.fetch({
        data : data,
        success : successCallback
        //    error : showError
      });
    }

    function navSearchParse(searchText) {

      var colModel = $dcGrid.jqGrid("getGridParam", "colModel"),
        rules = [],
        l = colModel.length,
        searchTextParts = $.trim(searchText.replace('/', ' ')).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
        cnParts = searchTextParts === null ? 0 : searchTextParts.length,
        i,
        iPart,
        token,
        cm;

      // normalize searchTextParts by removing quotes
      for (iPart = 0; iPart < cnParts; iPart++) {
        token = searchTextParts[iPart];
        if (token.length > 2 &&
          ((token[0] === '"' && token[token.length - 1] === '"') ||
          (token[0] === "'" && token[token.length - 1] === "'"))) {
          searchTextParts[iPart] = token.substr(1,token.length-2);
        }
      }

      var textParts = {};
      for (k=0; k<cnParts; k++) {
        st = searchTextParts[k];
        textParts[st] = [];
        $.each(colModel, function() {
          var cm1 = this;
          if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
            textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
          }
        });
      }
      globalFilter = textParts;
      //console.log('navSearchParse textParts');
      //console.log(searchText);

      $("#globalSearchText").val(searchText.replace('/', ' '));
      $("#globalSearch").click();
    }
    //added from data-catalog


    function jump(h){
      var url = location.href;               //Save down the URL without hash.
      location.href = "#"+h;                 //Go to the target element.
      history.replaceState(null,null,url);   //Don't like hashes. Changing it back.
    }

  </script>
  <script src="/js/compiled/data_catalog_sidebar.js" type="text/javascript"></script>
{% endblock %}
