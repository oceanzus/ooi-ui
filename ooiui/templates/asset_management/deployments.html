{% extends "common/base.html" %}

{% block title %}
  <title>Deployments</title>
{% endblock %}

{% block beforebootstrap %}

{% endblock %}

{% block head %}
  <link href="/css/compiled/index.css" rel="stylesheet" type="text/css" />
  <link rel="stylesheet" type="text/css" href="/css/common/assets.css">
  <link rel="stylesheet" type="text/css" href="/css/common/assetEditorModal.css">
  <link href="/css/compiled/asset_management.css" rel="stylesheet" type="text/css"/>


  <script src="/js/partials/compiled/index.js" type="text/javascript"></script>
  <script src="/js/partials/compiled/asset_management.js" type="text/javascript"></script>
  <script src="/js/compiled/index.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AssetView.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AssetEventsView.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AssetModel.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AssetEventsModel.js" type="text/javascript"></script>
  <script src="/js/models/asset_management/AlfrescoDocumentModel.js" type="text/javascript"></script>
  <script src="/js/views/asset_management/AlfrescoDocumentView.js" type="text/javascript"></script>
  <script src="/js/core/common/paginate.js" type="text/javascript"></script>
  <script src="/js/compiled/data_catalog.js" type="text/javascript"></script>

  <script type="text/javascript">
    $.jgrid.no_legacy_api = true;
    $.jgrid.useJSON = true;
  </script>

  {% block link %}
    {{ super() }}
  {% endblock %}
  {% block script %}
    {{ super() }}
  {% endblock %}
  <style>
    #search-param: { display: none; }
  </style>
{% endblock %}

{% block body %}
  <div class="container-fluid">
    <div id="navbar" class="row"></div>
  </div>

  <div id="wrapper" style="padding-left: 0">
    <div id="page-content-wrapper">
      <div class="container-fluid">
        <div id="page-content">

          <div class="row">
            <div class="col-md-12">
              <div class="col-md-4">
                <!-- jqGrid Assets-->
                <div>
                  <div id="navGrid" class="redmond"></div>
                  <table id="grid" class="redmond"></table>
                </div>
              </div>

              <div class="col-md-4">
                <!-- jqGrid Assets-->
                <div>
                  <div id="navGridNodes" class="redmond"></div>
                  <table id="gridNodes" class="redmond"></table>
                </div>
              </div>
              {#          </div> <!-- row -->#}

              {#          <div class="row">#}
              <div class="col-md-4">
                <!-- jqGrid Assets-->
                <div>
                  <div id="navGridSensors" class="redmond"></div>
                  <table id="gridSensors" class="redmond"></table>
                </div>
              </div>
            </div>
          </div> <!-- row -->


          <div class="row" style="padding-top:5px;">
            <div class="col-md-12" id="loadingSpinner" style="width:100%;">
              <span id="" style="margin-left:50%; font-size:18px;">
                <b>Loading table...</b><i class="fa fa-spinner fa-spin fa-4x"></i>
              </span>
            </div>
            <div class="col-md-12" id="rowButtons" hidden>

              <div id="dcGroupings">
                <button type='button' title='Reset Table Filters' style='float:left;margin-bottom:15px;' id='reset_table' class='btn btn-primary btn-xs' onclick='resetTable();'><i style='font-size:14px;float:left;pointer-events: none;'>Reset Table</i></button>
                <!-- Disabled until UFRAME brings back the capability
                <a target="_blank" href="/api/asset_deployment?export=json" id="assetExportBtn" class="btn btn-primary btn-xs" style="float:left;margin-bottom: 15px;margin-left: 5px;" disabled>Export Asset Information (JSON)</a>
                -->
              </div>

              <!-- jqGrid Assets-->


            </div>
            <div class="col-md-12" id="loadingSpinnerDeployments" style="width:100%;" hidden>
                <span id="" style="margin-left:50%; font-size:18px;">
                  <b>Loading deployments...</b><i class="fa fa-spinner fa-spin fa-4x"></i>
                </span>
            </div>
            <div class="col-md-12" id="deploymentsTableDiv">

              <div id="navGridDeployments" class="redmond"></div>
              <table id="gridDeployments" class="redmond"></table>
            </div>

          </div> <!-- row -->



        </div><!-- pagge-content -->
      </div><!-- .container-fluid -->
    </div><!-- #page-content-wrapper -->
  </div><!-- #wrapper -->

  <!-- Menu Toggle Script -->
  <script type="text/javascript">

    var bannerTitle = "Deployments";

    _.extend(OOI.prototype, Backbone.Events, {
      login: new LoginModel(),
      views: {
        headerView: null
      },
      models: {
        userModel: new UserModel()
      },
      start: function() {
        this.login.fetch({async:false});

        banner = new BannerView({bannerTitle: bannerTitle});

        navbar = new NavbarView({
          login: this.login
        });

        this.views.banner = new BannerView({bannerTitle : bannerTitle});
        $('body').prepend(this.views.banner.el);

        this.views.navbar = new NavbarView({
          el: $('#navbar')
        });

        this.views.navbar = new NavbarView();
        $('body').prepend(this.views.navbar.el);

        //checks and adds streaming title
        if (!_.isUndefined(this.views.banner) && this.views.banner.checkStreaming()){
          $('.container-fluid.banner-image').addClass('news-active')
        }

        this.listenTo(vent, "asset:renderDocsTable", function(model) {
          //renderRemoteDocuments(model);
        });

        this.listenTo(this, "login:success", this.onLogin);
        this.listenTo(this, "login:logout", this.onLogout);
        // TOC Controls
        this.listenTo(this, 'toc:selectArray', function(model) {
          {#          var searchFor = model.get('array_name').substr(0,14);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
        this.listenTo(this, 'toc:selectPlatform', function(model) {
          {#          var searchFor = model.get('ref_des').substr(0,8);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });

        this.listenTo(this, 'toc:selectInstrument', function(model) {
          {#          var searchFor = model.get('ref_des');#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
        this.listenTo(this, 'toc:selectAssembly', function(model) {
          {#          var searchFor = model.get('ref_des').substr(0,11);#}
          {#          $('#search').val(searchFor);#}
          {#          $('#search-clear').show();#}
          {#          updateCollection( showAssets );#}
        });
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
          var target = $(e.target).attr("name"); // activated tab
          var target_id = "#" + gridIdLookup[$(e.target).attr("href")];
          refreshEventTable(target, target_id);
        });
      }
    });

    var vent = _.extend({}, Backbone.Events);

    // Main collection for this page's asset information.
    var collection          = new AssetCollection();
    var assetCollection     = new AssetCollection();
    var arrayCollection     = new ArrayCollection();
    var streamCollection    = new StreamCollection();

    var ooi = new OOI();

    // url arguments
    var data = { min : 'True' };
    // begin the iterative fetching of arrays, assets, and streams.
    {#    var arrayFetch = arrayCollection.fetch({ reset: true });#}
    {#    var assetFetch = assetCollection.fetch({ data: data, reset: true });#}
    {#    var streamFetch = streamCollection.fetch({ data: data,  reset: true });#}

    var globalFilter = null;

    var currentAssetUid = null;

    var dataSourceUser = null;

    var unixTimeToDateTime = function(cellvalue) {
      var newDate = '';
      if(!_.isNull(cellvalue) && cellvalue > 0) {
        newDate = new Date(cellvalue);
      }
      if(!_.isNull(cellvalue) && cellvalue <= 0){
        newDate = 'Invalid Date'
      }
      return newDate;
    };

    var dateTimeToUnixTime = function(cellvalue) {
      var newDate = null;
      if(!_.isNull(cellvalue)) {
        newDate = Date.parse(cellvalue)
      }
      return newDate
    };

    var formatCellInt = function(cellvalue) {
      if(!_.isNull(cellvalue) && _.isString(cellvalue)) {
        return parseInt(cellvalue)
      }else{
        return cellvalue
      }
    };

    // Sets up the action buttons in the jqGrid table
    var createActionButtons = function(cellvalue, options, rowObject){
      {#      // console.log(rowObject);#}
      var actionButtons = "<div style='display: flex;justify-content: space-between;'>";
      actionButtons += "<button type='button' title='Data Access & Visualization' style='float:left' id='goPlot' class='btn btn-default' onclick=\"openPlot('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-bar-chart' aria-hidden='true'></i></button>";
      {#      actionButtons += "<button type='button' title='Download' style='float:right' id='goDownload' class='btn btn-default' onclick=\"openDownload('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-download' aria-hidden='true'></i></button>";#}
      {#      actionButtons += "<button type='button' title='Data Catalog' style='float:left' id='goDataCatalog' class='btn btn-default' onclick=\"openDataCatalog('"+rowObject.ref_des+"');\"><i style='font-size:14px;float:left;pointer-events: none;' class='fa fa-database' aria-hidden='true'></i></button>";#}
      actionButtons += "</div>";
      return actionButtons;
    };

    // Opens the plotting page
    var openPlot = function(ref_des){
      location.origin = location.protocol + "//" + location.host;
      var win = window.open(location.origin+"/data_access/#"+ref_des, '_blank');
      win.focus();
    };

    // Opens the download modal
    var openDownload = function(ref_des) {
      var dlModel = collection.where({ref_des:ref_des})[0];
      dlModel.attributes.email = ooi.models.userModel.attributes.email;
      ooi.trigger('StreamTableItemView:onClick', {model: dlModel});
    };

    var openDataCatalog = function(ref_des) {
      location.origin = location.protocol + "//" + location.host;
      var win = window.open(location.origin+"/datacatalog/#"+ref_des, '_blank');
      win.focus();
    };

    var getEditUrl = function() {
      {#      // console.log(lastsel2);#}
      location.origin = location.protocol + "//" + location.host;
      return location.origin+"/api/asset_deployment/"+lastsel2;
    };

    // Colors the end time
    var colorTime = function(cellvalue, options, rowObject) {
      var currentDate = new Date();
      var endDate = new Date(cellvalue);
      var timeSinceEndDate = currentDate.getTime()-endDate.getTime();

      // Base cell output is no background
      var cellOutput = '<i>'+cellvalue+'</i>';
      if(timeSinceEndDate <= 1000*60*60*12 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twelve-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate < 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="twenty-four-hours">'+cellvalue+'</i>';
      } else if(timeSinceEndDate >= 1000*60*60*24 && timeSinceEndDate >= 0){
        cellOutput = '<i class="older">'+cellvalue+'</i>';
      }
      return cellOutput;
    };

    $(document).ready(function() {
      $(".delayImg").each(function() {
        this.onload = function() {
          $(this).animate({opacity: 1}, 2000);
        };
        this.src = this.getAttribute("delayedSrc");
      });
      ooi.start();

      populate();
    });

    var resetTable = function() {
      $("#globalSearchText").val("");
      globalFilter = null;
      $("refresh_grid").click();
      $('.ui-search-toolbar').find('input[type="text"]').val('');
      $dcGrid.getGridParam("postData").filters = null;
      combineFilters();
    };

    var setScienceFilter = function(searchColumn, searchParam){
      {#      // console.log(event);#}
      var searchFiler = searchParam, grid = $("#grid"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      f.rules.push({field:searchColumn,op:"cn",data:searchFiler});
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var setNavFilter = function(searchColumn, searchParam){
      var searchFiler = searchParam.split(" "), grid = $("#grid"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      $.each (searchFiler, function() {
        f.rules.push({field:searchColumn,op:"bw",data:this});
      });
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var setEventFilter = function(searchColumn, searchParam){
      {#      // console.log(event);#}
      var searchFiler = searchParam, grid = $("#gridEvents"), f;
      if (searchFiler.length === 0) {
        grid[0].p.search = false;
        $.extend(grid[0].p.postData,{filters:""});
      }
      f = {groupOp:"OR",rules:[]};
      f.rules.push({field:searchColumn,op:"cn",data:searchFiler});
      grid[0].p.search = true;
      $.extend(grid[0].p.postData,{filters:JSON.stringify(f)});
      grid.trigger("reloadGrid",[{page:1,current:true}]);
    };

    var combineFilters = function() {
      // console.log('combineFilters');
      var allFilters = [];
      {#      if($dcGrid.getGridParam("postData").filters != null) {#}
      {#        // console.log($dcGrid.getGridParam("postData").filters);#}
      {#        allFilters.push(JSON.parse($dcGrid.getGridParam("postData").filters));#}
      {#      }#}

      var combinedFilters = {
        groupOp:"AND",
        rules:[],
        groups:allFilters
      };

      // Global filter
      var ggg = {groupOp:"OR", rules:[], groups:[]};
      if(globalFilter != null){
        $.each(globalFilter, function() {
          $.each(this, function() {
            ggg.groups.push(this);
          });

          combinedFilters.groups.push(ggg);
          ggg = {groupOp:"OR", rules:[], groups:[]};
        });
      }

      // Ensure $dcGrid is defined (page load race conditions) before attempting to set filters
      if (!_.isUndefined($dcGrid[0].p)) {
        $dcGrid[0].p.search = true;
        $.extend($dcGrid[0].p.postData,{filters:JSON.stringify(combinedFilters)});
        $dcGrid.trigger("reloadGrid",[{page:1,current:true}]);
      }
    };

    var numberTemplate = {
      formatter : 'number',
      align : 'right',
      sorttype : 'number',
      editable : true,
      searchoptions : { sopt : ['eq', 'ne', 'lt', 'le', 'gt', 'ge', 'nu', 'nn', 'in', 'ni'] }
    };

    var defaultFilters = {
      "groupOp" : "AND",
      "rules" : [
        { "field" : "All", "op" : "cn", "data" : ""}
      ]
    };

    var $dcGrid = $("#grid");
    var $dcGridNodes = $("#gridNodes");
    var $dcGridSensors = $("#gridSensors");
    var $dcGridDeployments = $('#gridDeployments');

    var lastsel2;

    var getUniqueNames = function(columnName) {
        var texts = $dcGrid[0].p.data, uniqueTexts = [],
          textsLength = texts.length, text, textsMap = {}, i;
        for (i=0;i<textsLength;i++) {
          text = texts[i][columnName];
          if (text !== undefined && textsMap[text] === undefined) {
            // to test whether the texts is unique we place it in the map.
            textsMap[text] = true;
            uniqueTexts.push(text);
          }
        }
        {#        // console.log(uniqueTexts);#}
        return uniqueTexts;
      },
      buildSearchSelect = function(uniqueNames) {
        var values=":All";
        $.each (uniqueNames, function() {
          values += ";" + this + ":" + this;
        });
        return values;
      },
      setSearchSelect = function(columnName) {
        $dcGrid.jqGrid('setColProp', columnName,
          {
            stype: 'select',
            searchoptions: {
              value:buildSearchSelect(getUniqueNames(columnName)),
              sopt:['eq']
            }
          }
        );
      };

    //define handler for 'editSubmit' event
    var fn_editSubmit=function(response,postdata){
      {#      // console.log('fn_editSubmit');#}
      {#      // console.log(response);#}
      {#      // console.log(postdata);#}
      var json=response.responseText; //in my case response text form server is "{sc:true,msg:''}"
      var result=eval("("+json+")"); //create js object from server reponse
      {#      // console.log(result);#}
      return [result,null];
    };

    //define edit options for navgrid
    var editOptions={
      {#      top: 50, left: "100", width: 500,#}
      closeOnEscape: true, afterSubmit: fn_editSubmit
    };

    function exportData(e, id){

      var gridid 		= jQuery(id).getDataIDs(); // Get all the ids in array
      var label 		= jQuery(id).getRowData(gridid[0]); // Get First row to get the labels
      var selRowIds 	= jQuery(id).jqGrid ('getGridParam', 'selarrrow');

      var obj 		= new Object();
      obj.count		= selRowIds.length;

      if(obj.count) {

        obj.items		= new Array();

        for(elem in selRowIds) {
          obj.items.push(jQuery(id).getRowData( selRowIds[elem] ));
        }

        var json = JSON.stringify(obj);

        JSONToCSVConverter(json, "csv", 1);
      }
    }

    function JSONToCSVConverter(JSONData, ReportTitle, ShowLabel) {

      //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
      var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;
      var CSV = '';
      //This condition will generate the Label/Header
      if (ShowLabel) {
        var row = "";

        //This loop will extract the label from 1st index of on array
        for (var index in arrData.items[0]) {
          //Now convert each value to string and comma-seprated
          row += index + ',';
        }
        row = row.slice(0, -1);
        //append Label row with line break
        CSV += row + '\r\n';
      }

      //1st loop is to extract each row
      for (var i = 0; i < arrData.items.length; i++) {
        var row = "";
        //2nd loop will extract each column and convert it in string comma-seprated
        for (var index in arrData.items[i]) {
          row += '"' + arrData.items[i][index].replace(/(<([^>]+)>)/ig, '') + '",';
        }
        row.slice(0, row.length - 1);
        //add a line break after each row
        CSV += row + '\r\n';
      }

      if (CSV == '') {
        alert("Invalid data");
        return;
      }

      //this trick will generate a temp "a" tag
      var link = document.createElement("a");
      link.id="lnkDwnldLnk";

      //this part will append the anchor tag and remove it after automatic click
      document.body.appendChild(link);

      var csv = CSV;
      blob = new Blob([csv], { type: 'text/csv' });

      var myURL = window.URL || window.webkitURL;

      var csvUrl = myURL.createObjectURL(blob);
      var filename = 'UserExport.csv';
      jQuery("#lnkDwnldLnk")
        .attr({
          'download': filename,
          'href': csvUrl
        });

      jQuery('#lnkDwnldLnk')[0].click();
      document.body.removeChild(link);

    }

    var highlightFilteredData = function () {
      var $self = $(this), filters, i, l, rules, rule, iCol,
        isFiltered = $self.jqGrid("getGridParam", "search"),
        postData = $self.jqGrid("getGridParam", "postData"),
        colModel = $self.jqGrid("getGridParam", "colModel"),
        colIndexByName = {};

      // validate whether we have input for highlighting
      if (!isFiltered || typeof postData !== "object") {
        return;
      }
      filters = $.parseJSON(postData.filters);
      if (filters == null || filters.rules == null || filters.rules.length <= 0) {
        return;
      }

      // fill colIndexByName which get easy column index by the column name
      for (i = 0, l = colModel.length; i < l; i++) {
        colIndexByName[colModel[i].name] = i;
      }

      rules = filters.rules;
      for (i = 0, l = rules.length; i < l; i++) {
        rule = rules[i];
        iCol = colIndexByName[rule.field];
        if (iCol !== undefined) {
          $self.find(">tbody>tr.jqgrow>td:nth-child(" + (iCol + 1) + ")").highlight(rule.data);
        }
      }
    };

    var refreshNodesTable = function() {
      // console.log(currentSubsiteRd);
      var theDataUrl = "";
      if (!_.isUndefined(currentSubsiteRd) && !_.isNull(currentSubsiteRd)) {
        theDataUrl = "/api/deployments/"+currentSubsiteRd+"/nodes";
        // console.log(theDataUrl);

        $.ajax( theDataUrl, {
          type: 'GET',
          dataType: 'json',
          success: function( resp ) {
          },
          complete: function(jsondata,stat){
            if(stat=="success") {
              var theData = jsondata.responseJSON;
              // console.log(theData.nodes);
              $dcGridNodes.setGridParam({data:theData.nodes});
              $dcGridNodes.trigger("reloadGrid",[{page:1,current:true}]);
            }
          },
          error: function( req, status, err ) {
          }
        });
      }
    };

    var refreshSensorsTable = function() {
      // console.log(currentNodeRd);
      var theDataUrl = "";
      if (!_.isUndefined(currentNodeRd) && !_.isNull(currentNodeRd)) {
        theDataUrl = "/api/deployments/"+currentSubsiteRd+"/"+currentNodeRd.split('-')[1]+"/sensors";
        // console.log(theDataUrl);

        $.ajax( theDataUrl, {
          type: 'GET',
          dataType: 'json',
          success: function( resp ) {
          },
          complete: function(jsondata,stat){
            if(stat=="success") {
              var theData = jsondata.responseJSON;
              // console.log(theData.sensors);
              $dcGridSensors.setGridParam({data:theData.sensors});
              $dcGridSensors.trigger("reloadGrid",[{page:1,current:true}]);
            }
          },
          error: function( req, status, err ) {
          }
        });
      }
    };

    var refreshDeploymentsTable = function() {
      $dcGridDeployments.jqGrid("clearGridData");
      $('#deploymentsTableDiv').hide();
      $("#loadingSpinnerDeployments").show();
      // console.log('refreshEventTable');
      // console.log(currentAssetId);
      // console.log(gridId);
      // console.log('currentDeploymentRd before refreshDeploymentsTable');
      // console.log(currentDeploymentRd);
      var theDataUrl = "/api/deployments/"+currentDeploymentRd;

      $.ajax( theDataUrl, {
        type: 'GET',
        dataType: 'json',
        success: function( resp ) {

        },
        complete: function(jsondata,stat){
          if(stat=="success") {
            // console.log(jsondata.responseJSON);
            // console.log(eventData[theName].events[theName]);
            var assetTableData = jsondata.responseJSON.deployments;
            assetTableData['actions'] = '';
            $dcGridDeployments.setGridParam({data:assetTableData});
            {#            resetTable();#}
            $dcGridDeployments.trigger("reloadGrid",[{page:1,current:true}]);
            {#            resetTable();#}
          }
          $("#loadingSpinnerDeployments").hide();
          $('#deploymentsTableDiv').show();
        },
        error: function( req, status, err ) {

        }
      });

      {#        $(gridId).setGridParam({url:theDataUrl});#}
      {#        $(gridId).trigger("reloadGrid",[{page:1,current:true}]);#}
    };

    var showRows = function() {
      $("#loadingSpinner").hide();
      $("#loadingSpinnerDeployments").hide();
      $("#rowButtons").hide();
      {#      $("#rowFilters").show();#}
      {#      $("#rowSubGrids").show();#}
      $("#rowAlfresco").hide();
      $("#rowEvents").show();
    };

    var currentSubsiteRd;
    var currentNodeRd;
    var currentSensorRd;
    var currentDeploymentRd;


    // Loads the jqGrid into
    function placeJqGrid(collection) {
      var pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
      var currentUser = null;
      if(ooi.login.loggedIn()) {
        currentUser = ooi.models.userModel.fetch({url: '/api/current_user', async:false});
      }

      if (!_.isNull(currentUser) && !_.isUndefined(currentUser.responseJSON.scopes)){
        if($.inArray("asset_manager", currentUser.responseJSON.scopes) >= 0){
          pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
        }
      }

      // console.log(collection['subsites']);
      $dcGrid.jqGrid({
        datatype : "local",
        data : collection['subsites'],
        editurl : "",
        serializeEditData: function(postData) {
          jsonResponse = JSON.stringify(postData);
          return jsonResponse;
        },
        colNames: [
          'Key',
          'Array',
          'Name',
          'Reference Designator'
        ],

        colModel : [
          {
            name : 'key',
            index : 'key',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'array',
            index : 'array',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'name',
            index : 'name',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'rd',
            index : 'rd',
            editrules: {required:true, edithidden:true},
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        loadComplete : function() {
          $("#navGrid").find("option[value=\"50000\"]").text('All');
          highlightFilteredData.call(this);
          showRows();
        },
        beforeRequest: function(){

        },
        onSelectRow: function (rowId, status, e) {
          $dcGridNodes.jqGrid("clearGridData");
          $dcGridSensors.jqGrid("clearGridData");
          $dcGridDeployments.jqGrid("clearGridData");


          var selRows = $dcGrid.jqGrid('getGridParam','selrow');
          if (selRows.length === 0) {
            // No rows selected
            currentSubsiteRd = null;
          } else {
            // Row has been selected
            currentSubsiteRd = $dcGrid.getRowData(rowId).rd;
            currentDeploymentRd = $dcGrid.getRowData(rowId).rd;
            // console.log('currentDeploymentRd for subsites');
            // console.log(currentDeploymentRd);
          }

          refreshNodesTable();
          refreshDeploymentsTable();
        },
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 10,
        rowList : [10, 20, 30, 40, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGrid',
        sortname : 'eventId',
        autoencode: true,
        viewrecords : true,
        sortorder : 'asc',
        sortable : true,
        caption : 'Subsites',
        altRows: false,
        ignoreCase: true,
        shrinkToFit : true,
        multiselect: false,
        multiboxonly: true,
        reloadAfterSubmit : true,
        loadOnce : false
      }).jqGrid('navGrid',
        '#navGrid',
        pagerOptions
        ,{} /* edit options */
        ,{} /* add options */
        ,{} /*delete options*/
        ,{multipleSearch:false}
        ,{closeOnEscape:true}
      );

      // Column mover and chooser
      $dcGrid.jqGrid('navButtonAdd', '#navGrid', {
        caption: "showcolumns",
        buttonicon: "ui-icon-calculator",
        title: "Choose columns",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{});
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              alert('column "' + $(this).parent().text() + '" is chosen');
            });
        }
      });

      if(location.hash!=""){
        setScienceFilter('ref_des', location.hash.split('#')[1]);
      }

      var performGlobalSearch = function(searchText) {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
          {#          searchText = $("#globalSearchText").val(),#}
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        var textParts = {};
        for (k=0; k<cnParts; k++) {
          st = searchTextParts[k];
          textParts[st] = [];
          $.each(colModel, function() {
            var cm1 = this;
            if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
              textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
            }
          });
        }
        globalFilter = textParts;

        combineFilters();
      };

      // fill top toolbar
      var $grid = $dcGrid;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchText\">Global search in grid for:&nbsp;</label><input id=\"globalSearchText\" type=\"text\"></input>&nbsp;<button id=\"globalSearch\" type=\"button\">Search</button></div>"));
      $("#globalSearchText").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          initialLocationSearch = "";
          performGlobalSearch($("#globalSearchText").val());
        }
      });
      $("#globalSearch").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        initialLocationSearch = "";
        performGlobalSearch($("#globalSearchText").val());
      });

    } // placeJqGrid

    function placeJqGridNodes() {
      var pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
      var currentUser = null;
      if(ooi.login.loggedIn()) {
        currentUser = ooi.models.userModel.fetch({url: '/api/current_user', async:false});
      }

      if (!_.isNull(currentUser) && !_.isUndefined(currentUser.responseJSON.scopes)){
        if($.inArray("asset_manager", currentUser.responseJSON.scopes) >= 0){
          pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
        }
      }

      $dcGridNodes.jqGrid({
        datatype : "local",
        data : [],
        editurl : "",
        serializeEditData: function(postData) {
          jsonResponse = JSON.stringify(postData);
          return jsonResponse;
        },
        colNames: [
          'Key',
          'Array',
          'Name',
          'Reference Designator'
        ],

        colModel : [
          {
            name : 'key',
            index : 'key',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'array',
            index : 'array',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'name',
            index : 'name',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'rd',
            index : 'rd',
            editrules: {required:true, edithidden:true},
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        loadComplete : function() {
          $("#navGridNodes").find("option[value=\"50000\"]").text('All');
        },
        beforeRequest: function(){

        },
        onSelectRow: function (rowId, status, e) {

          $dcGridSensors.jqGrid("clearGridData");

          var selRows = $dcGridNodes.jqGrid('getGridParam','selrow');
          if (selRows.length === 0) {
            // No rows selected
            currentNodeRd = null;
          } else {
            // Row has been selected
            currentNodeRd = $dcGridNodes.getRowData(rowId).rd;
            currentDeploymentRd = $dcGridNodes.getRowData(rowId).rd;
            // console.log('currentDeploymentRd for nodes');
            // console.log(currentDeploymentRd);
          }

          refreshSensorsTable();
          refreshDeploymentsTable();
        },
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 10,
        rowList : [10, 20, 30, 40, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGridNodes',
        sortname : 'array',
        autoencode: true,
        viewrecords : true,
        sortorder : 'asc',
        sortable : true,
        caption : 'Nodes',
        altRows: false,
        ignoreCase: true,
        shrinkToFit : true,
        multiselect: false,
        multiboxonly: true,
        reloadAfterSubmit : true,
        loadOnce : false
      }).jqGrid('navGrid',
        '#navGridNodes',
        pagerOptions
        ,{} /* edit options */
        ,{} /* add options */
        ,{} /*delete options*/
        ,{multipleSearch:false}
        ,{closeOnEscape:true}
      );

      // Column mover and chooser
      $dcGridNodes.jqGrid('navButtonAdd', '#navGridNodes', {
        caption: "showcolumns",
        buttonicon: "ui-icon-calculator",
        title: "Choose columns",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{});
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              alert('column "' + $(this).parent().text() + '" is chosen');
            });
        }
      });

      if(location.hash!=""){
        setScienceFilter('ref_des', location.hash.split('#')[1]);
      }

      var performGlobalSearch = function(searchText) {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
          {#          searchText = $("#globalSearchText").val(),#}
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        var textParts = {};
        for (k=0; k<cnParts; k++) {
          st = searchTextParts[k];
          textParts[st] = [];
          $.each(colModel, function() {
            var cm1 = this;
            if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
              textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
            }
          });
        }
        globalFilter = textParts;

        combineFilters();
      };

      // fill top toolbar
      var $grid = $dcGridNodes;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchText\">Global search in grid for:&nbsp;</label><input id=\"globalSearchText\" type=\"text\"></input>&nbsp;<button id=\"globalSearch\" type=\"button\">Search</button></div>"));
      $("#globalSearchText").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          initialLocationSearch = "";
          performGlobalSearch($("#globalSearchText").val());
        }
      });
      $("#globalSearch").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        initialLocationSearch = "";
        performGlobalSearch($("#globalSearchText").val());
      });

    } // placeJqGridNodes

    function placeJqGridSensors() {
      var pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
      var currentUser = null;
      if(ooi.login.loggedIn()) {
        currentUser = ooi.models.userModel.fetch({url: '/api/current_user', async:false});
      }

      if (!_.isNull(currentUser) && !_.isUndefined(currentUser.responseJSON.scopes)){
        if($.inArray("asset_manager", currentUser.responseJSON.scopes) >= 0){
          pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
        }
      }

      $dcGridSensors.jqGrid({
        datatype : "local",
        data : [],
        editurl : "",
        serializeEditData: function(postData) {
          jsonResponse = JSON.stringify(postData);
          return jsonResponse;
        },
        colNames: [
          'Key',
          'Array',
          'Name',
          'Reference Designator'
        ],

        colModel : [
          {
            name : 'key',
            index : 'key',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'array',
            index : 'array',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'name',
            index : 'name',
            editrules: {required:true, edithidden:true},
            editable : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'rd',
            index : 'rd',
            editrules: {required:true, edithidden:true},
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        loadComplete : function() {
          $("#navGridSensors").find("option[value=\"50000\"]").text('All');
        },
        beforeRequest: function(){

        },
        onSelectRow: function (rowId, status, e) {

          $dcGridDeployments.jqGrid("clearGridData");

          var selRows = $dcGridSensors.jqGrid('getGridParam','selrow');
          if (selRows.length === 0) {
            // No rows selected
            currentSensorRd = null;
          } else {
            // Row has been selected
            currentSensorRd = $dcGridSensors.getRowData(rowId).rd;
            currentDeploymentRd = $dcGridSensors.getRowData(rowId).rd;
            // console.log('currentDeploymentRd for sensors');
            // console.log(currentDeploymentRd);
          }

          refreshDeploymentsTable();
        },
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 10,
        rowList : [10, 20, 30, 40, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGridSensors',
        sortname : 'array',
        autoencode: true,
        viewrecords : true,
        sortorder : 'asc',
        sortable : true,
        caption : 'Sensors',
        altRows: false,
        ignoreCase: true,
        shrinkToFit : true,
        multiselect: false,
        multiboxonly: true,
        reloadAfterSubmit : true,
        loadOnce : false
      }).jqGrid('navGrid',
        '#navGridSensors',
        pagerOptions
        ,{} /* edit options */
        ,{} /* add options */
        ,{} /*delete options*/
        ,{multipleSearch:false}
        ,{closeOnEscape:true}
      );

      // Column mover and chooser
      $dcGridNodes.jqGrid('navButtonAdd', '#navGridSensors', {
        caption: "showcolumns",
        buttonicon: "ui-icon-calculator",
        title: "Choose columns",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{});
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              alert('column "' + $(this).parent().text() + '" is chosen');
            });
        }
      });

      if(location.hash!=""){
        setScienceFilter('ref_des', location.hash.split('#')[1]);
      }

      var performGlobalSearch = function(searchText) {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
          {#          searchText = $("#globalSearchText").val(),#}
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        var textParts = {};
        for (k=0; k<cnParts; k++) {
          st = searchTextParts[k];
          textParts[st] = [];
          $.each(colModel, function() {
            var cm1 = this;
            if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
              textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
            }
          });
        }
        globalFilter = textParts;

        combineFilters();
      };

      // fill top toolbar
      var $grid = $dcGridSensors;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchText\">Global search in grid for:&nbsp;</label><input id=\"globalSearchText\" type=\"text\"></input>&nbsp;<button id=\"globalSearch\" type=\"button\">Search</button></div>"));
      $("#globalSearchText").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          initialLocationSearch = "";
          performGlobalSearch($("#globalSearchText").val());
        }
      });
      $("#globalSearch").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        initialLocationSearch = "";
        performGlobalSearch($("#globalSearchText").val());
      });

    } // placeJqGridSensors


    var eventNameCol = {
      name : 'eventName',
      index : 'eventName',
      jsonmap : 'eventName',
      editrules: {required:false, edithidden:false},
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'string',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var eventIdCol = {
      name : 'eventId',
      key : false,
      index : 'eventId',
      jsonmap : 'eventId',
      editrules: {required:false, edithidden:true},
      editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'int',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var eventStartTimeCol = {
      name : 'eventStartTime',
      index : 'eventStartTime',
      jsonmap : 'eventStartTime',
      editrules: {required:false, edithidden:true},
      formatter : 'date',
      formatoptions : {srcformat: 'U/1000',newformat: 'ISO8601Long'},
      editable : true,
      sortable : true,
      sorttype : 'date',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center'
    };

    var eventStopTimeCol = {
      name : 'eventStopTime',
      index : 'eventStopTime',
      jsonmap : 'eventStopTime',
      editrules: {required:false, edithidden:true},
      formatter : 'date',
      formatoptions : {srcformat: 'U/1000',newformat: 'ISO8601Long'},
      editable : true,
      sortable : true,
      sorttype : 'date',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center'
    };

    var eventTypeCol = {
      name : 'eventType',
      index : 'eventType',
      jsonmap : 'eventType',
      editrules: {required:false, edithidden:true},
      editoptions:{
        dataInit: function(element) { $(element).attr("readonly", "readonly"); }
      },
      editable : true,
      hidden : true,
      sortable : true,
      sorttype : 'string',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var notesCol = {
      name : 'notes',
      index : 'notes',
      jsonmap : 'notes',
      editrules : {required:false, edithidden:true},
      editoptions : {rows:"10",cols:"80"},
      edittype : 'textarea',
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'string',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      {#        align : 'center',#}
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var assetUidCol = {
      name : 'assetUid',
      index : 'assetUid',
      jsonmap : 'assetUid',
      editrules: {required:false, edithidden:true},
      editoptions:{
        defaultValue : function() { return currentAssetUid;}
      },
      editable : true,
      hidden : true,
      sortable : true,
      sorttype : 'string',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var dataSourceCol = {
      name: 'dataSource',
      index: 'dataSource',
      jsonmap: 'dataSource',
      editrules: {required: false, edithidden: true},
      editoptions:{
        dataInit: function(element) { $(element).attr("readonly", "readonly"); },
        defaultValue : function() { return dataSourceUser;},
      },
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'string',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var lastModifiedTimestampCol = {
      name : 'lastModifiedTimestamp',
      index : 'lastModifiedTimestamp',
      jsonmap : 'lastModifiedTimestamp',
      editrules: {required:false, edithidden:true},
      editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
      {#      formatter : 'date',#}
      {#      formatoptions : {srcformat: 'U/1000',newformat: 'ISO8601Long'},#}
      editable : true,
      hidden : true,
      sortable : true,
      sorttype : 'date',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center'
    };

    var eventLatitudeCol = {
      name : 'latitude',
      index : 'latitude',
      editrules: {required:false, edithidden:true, number:true},
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'number',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    var eventLongitudeCol = {
      name : 'longitude',
      index : 'longitude',
      editrules: {required:false, edithidden:true, number:true},
      editable : true,
      hidden : false,
      sortable : true,
      sorttype : 'number',
      searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
      align : 'center',
      unformat : function (cellvalue, options, cell) {
        return $('input', cell).val() || cellvalue;
      }
    };

    function containsNonLatinCodepoints(s) {
      return /[^\\u0000-\\u00ff]/.test(s);
    }

















    // Loads the jqGrid into
    function placeJqGridDeployments() {
      {#      {
              "assetUid": null,
              "dataSource": "Load from [CE02SHSP_Deploy.xlsx]2016-09-29 02:36:20.317183",
              "deployCruiseInfo": null,
              "deployedBy": "Test user - 48121",
              "deploymentNumber": 1,
              "depth": 0.0,
              "editPhase": "EDIT",
              "eventId": 23643,
              "eventName": "CE02SHSP-SP001-00-SPPENG000",
              "eventStartTime": 1426706400000,
              "eventStopTime": 1427932800000,
              "eventType": "DEPLOYMENT",
              "inductiveId": null,
              "ingestInfo": [
              {
                "@class": ".IngestInfo",
                "id": 23644,
                "ingestMask": "*PDBG.txt",
                "ingestMethod": "recovered_cspp",
                "ingestPath": "/omc_data/whoi/OMC/CE02SHSP/R00001/extract/",
                "ingestQueue": "Ingest.dbg-pdbg-cspp_recovered"
              },
              {
                "@class": ".IngestInfo",
                "id": 23645,
                "ingestMask": "*WC_HMR.txt",
                "ingestMethod": "recovered_cspp",
                "ingestPath": "/omc_data/whoi/OMC/CE02SHSP/R00001/extract/",
                "ingestQueue": "Ingest.wc-hmr-cspp_recovered"
              },
              {
                "@class": ".IngestInfo",
                "id": 23646,
                "ingestMask": "*WC_SBE.txt",
                "ingestMethod": "recovered_cspp",
                "ingestPath": "/omc_data/whoi/OMC/CE02SHSP/R00001/extract/",
                "ingestQueue": "Ingest.wc-sbe-cspp_recovered"
              },
              {
                "@class": ".IngestInfo",
                "id": 23647,
                "ingestMask": "*WC_WM.txt",
                "ingestMethod": "recovered_cspp",
                "ingestPath": "/omc_data/whoi/OMC/CE02SHSP/R00001/extract/",
                "ingestQueue": "Ingest.wc-wm-cspp_recovered"
              }
            ],
              "lastModifiedTimestamp": 1475130981877,
              "latitude": 44.6391,
              "location": {},
              "longitude": -124.30043,
              "mooring_uid": "N00285",
              "node_uid": "N00121",
              "notes": null,
              "orbitRadius": 8.0,
              "rd": "CE02SHSP-SP001-00-SPPENG000",
              "recoverCruiseInfo": null,
              "recoveredBy": null,
              "sensor_uid": "R00100",
              "versionNumber": 2
            }#}

      var pagerOptions = {add:false, view:true, del:false, refresh:false, edit:false,pdf:false,search:true};
      var currentUser = null;
      if(ooi.login.loggedIn()) {
        currentUser = ooi.models.userModel.fetch({url: '/api/current_user', async:false});
      }
      if (!_.isNull(currentUser) && !_.isUndefined(currentUser.responseJSON.scopes)){
        if($.inArray("asset_manager", currentUser.responseJSON.scopes) >= 0){
          pagerOptions = {add:true, view:true, del:false, refresh:false, edit:true,pdf:false,search:true};
        }
      }

      $dcGridDeployments.jqGrid({
        datatype : "local",
        data : [],
        editurl : "/api/deployments/ajax",
        serializeEditData: function(postData) {
          return JSON.stringify(postData);
        },
        colNames: [
          'Actions',
          'Event ID',
          'Asset UID',
          'Data Source',
          'Deployment Number',
          'Depth',
          'Notes',
          'Reference Designator',
          'Last Modified',
          'Latitude',
          'Longitude',
          'Orbit Radius',
          'Edit Phase',
          'Deployed By',
          'Event Name',
          'Start Date',
          'Stop Date',
          'Event Type',
          'Inductive ID',
          'Version Number',
          'Mooring UID',
          'Node UID',
          'Sensor UID',
          'Recovered By',
          'Deployed Cruise Info',
          'Recovered Cruise Info',
          'Ingest Info'
        ],

        colModel : [
          { name : 'actions',
            caption : 'Plot/Download',
            editrules: {required:false, edithidden:false},
            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
            editable : false,
            hidden : false,
            width : 80,
            sortable : false,
            search : false,
            align : 'center',
            formatter : createActionButtons
          },
          {
            name : 'eventId',
            key : true,
            index : 'eventId',
            jsonmap : 'eventId',
            editrules: {required:false, edithidden:true},
            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'int',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'assetUid',
            index : 'assetUid',
            jsonmap : 'assetUid',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          dataSourceCol,
          {
            name : 'deploymentNumber',
            index : 'deploymentNumber',
            jsonmap : 'deploymentNumber',
            editrules: {required:false, edithidden:true},
            // editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'depth',
            index : 'depth',
            jsonmap : 'depth',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align: 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          notesCol,
          {
            name: 'rd',
            index: 'rd',
            jsonmap : 'rd',
            editrules: {required:false, edithidden:true},
            // editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},
            editable : true,
            hidden : false,
            width: 240,
            sortable: true,
            sorttype: 'string',
            searchoptions: {sopt: ['cn', 'eq', 'ne', 'lt', 'le', 'gt', 'ge', 'bw', 'bn', 'in', 'ni', 'ew', 'en', 'nc']},
            align: 'center',
            unformat: function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          lastModifiedTimestampCol,
          eventLatitudeCol,
          eventLongitudeCol,
          {
            name : 'orbitRadius',
            index : 'orbitRadius',
            jsonmap : 'orbitRadius',
            editrules: {required:false, edithidden:true, number:true},
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'number',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            // TODO: Pull down
            name : 'editPhase',
            index : 'editPhase',
            jsonmap : 'editPhase',
            editrules: {required:false, edithidden:true},
            editoptions:{ dataUrl : '/api/asset_deployment/edit_phase_values'},
            editable : true,
            edittype : 'select',
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'deployedBy',
            index : 'deployedBy',
            jsonmap : 'deployedBy',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          eventNameCol,
          eventStartTimeCol,
          eventStopTimeCol,
          eventTypeCol,
          {
            name : 'inductiveId',
            index : 'inductiveId',
            jsonmap : 'inductiveId',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'versionNumber',
            index : 'versionNumber',
            jsonmap : 'versionNumber',
            editrules: {required:false, edithidden:true},
{#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'mooring_uid',
            index : 'mooring_uid',
            jsonmap : 'mooring_uid',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'node_uid',
            index : 'node_uid',
            jsonmap : 'node_uid',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'sensor_uid',
            index : 'sensor_uid',
            jsonmap : 'sensor_uid',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'recoveredBy',
            index : 'recoveredBy',
            jsonmap : 'recoveredBy',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'deployCruiseInfo',
            index : 'deployCruiseInfo',
            jsonmap : 'deployCruiseInfo',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'recoverCruiseInfo',
            index : 'recoverCruiseInfo',
            jsonmap : 'recoverCruiseInfo',
            editrules: {required:false, edithidden:true},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : true,
            hidden : false,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          },
          {
            name : 'ingestInfo',
            index : 'ingestInfo',
            jsonmap : 'ingestInfo',
            editrules: {required:false, edithidden:false},
            {#            editoptions:{ dataInit: function(element) { $(element).attr("readonly", "readonly"); }},#}
            editable : false,
            hidden : true,
            sortable : true,
            sorttype : 'string',
            searchoptions : {sopt:['cn','eq','ne','lt','le','gt','ge','bw','bn','in','ni','ew','en','nc']},
            align : 'center',
            unformat : function (cellvalue, options, cell) {
              return $('input', cell).val() || cellvalue;
            }
          }
        ],
        {#        ondblClickRow: function (id) { alert("You double click row with id: " + id); },#}
        loadComplete : function() {
          $("#navGridDeployments").find("option[value=\"50000\"]").text('All');
          {#          highlightFilteredData.call(this);#}
          {#          showRows();#}
        },
        gridComplete : function() {

        },
        beforeRequest: function(){

        },
        onSelectRow: function (rowId, status, e) {

        },
        gridview : true,
        toolbar: [true, "top"],
        rowNum : 10,
        rowList : [10, 20, 30, 40, 50000],
        autowidth : true,
        height : 'auto',
        pager : '#navGridDeployments',
        sortname : 'id',
        autoencode: true,
        viewrecords : true,
        sortorder : 'asc',
        sortable : true,
        caption : 'Deployments',
        altRows: false,
        ignoreCase: true,
        shrinkToFit : true,
        multiselect: false,
        multiboxonly: true,
        reloadAfterSubmit : true,
        loadOnce : false,
        ajaxEditOptions : {
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          mtype: "POST",
          errorTextFormat : function(serviceResponse){
            var messageText = JSON.parse(serviceResponse.responseText).message;
            return messageText;
          }
        }
      }).jqGrid('navGrid',
        '#navGridDeployments',
        pagerOptions
        ,{ajaxEditOptions: { contentType: "application/json; charset=utf-8" },
          serializeEditData: function (postdata) {
            return JSON.stringify(postdata);
          },
          errorTextFormat : function(serviceResponse){
            var messageText = JSON.parse(serviceResponse.responseText).message;
            return messageText;
          },
          beforeShowForm: function(id) {
            $('#tr_eventName').hide();
            $('#dataSource').val('UI:user='+currentUser.responseJSON.user_name);
          },
          onClose: function() {
          },
          afterSubmit : function(response, postdata)
          {
            var success = false;
            var message = response.statusText;
            // console.log(response);
            if(response.status == 200){
              success = true;
              message = "Record saved successfully.";
              refreshDeploymentsTable();
            }

            return [success,message]
          },
          beforeSubmit: function(postdata) {
            // Form Validations
            if (!moment(postdata.eventStartTime, 'YYYY-MM-DD HH:mm:ss',true).isValid() && postdata.eventStartTime.length>0){
              return [false, 'Event Start Time format invalid (ex. 2014-09-23 09:45:12)'];
            }

            if (!moment(postdata.eventStopTime, 'YYYY-MM-DD HH:mm:ss',true).isValid() && postdata.eventStopTime.length>0){
              return [false, 'Event Stop Time format invalid (ex. 2014-09-23 09:45:12)'];
            }

            // Fix the dates
            if (!_.isNull(postdata.eventStartTime) && postdata.eventStartTime.length > 0) {
              postdata.eventStartTime = String(Date.parse(postdata.eventStartTime + " GMT"));
            } else {
              postdata.eventStartTime = '';
            }

            if (!_.isNull(postdata.eventStopTime) && postdata.eventStopTime.length > 0) {
              postdata.eventStopTime = String(Date.parse(postdata.eventStopTime + " GMT"));
            } else {
              postdata.eventStopTime = '';
            }

            var selRows = $dcGridDeployments.jqGrid('getGridParam','selrow');
            {#            // console.log(selRows);#}
            var currentRowData = $dcGridDeployments.getRowData(selRows);
            // console.log('currentRowData');
            // console.log(currentRowData);
            var theColModel = $dcGridDeployments.jqGrid('getGridParam', 'colModel');
            {#            // console.log(theColModel);#}
            {#            // console.log(postdata);#}
            $.each(theColModel, function() {
              var cm1 = this;
              var theName = cm1.name;
              {#              // console.log(theName);#}
              if (!(theName in postdata) && (theName != 'actions')) {
                {#                // console.log(currentRowData[theName]);#}
                if(theName == 'ingestInfo'){
                  postdata[theName] = "["+currentRowData[theName]+"]";
                } else {
                  postdata[theName] = currentRowData[theName];
                }

                // console.log(currentRowData[theName]);
                if(containsNonLatinCodepoints(currentRowData[theName])){
                  // console.log('unicode data detected');
                  // console.log(currentRowData[theName]);
                  postdata[theName] = "";
                }

              }

              if (theName.includes('Date')){
                // console.log('Date Before');
                // console.log(postdata[theName]);
                if (!_.isNull(postdata[theName]) && postdata[theName].length > 0) {
                  postdata[theName] = String(Date.parse(postdata[theName] + " GMT"));
                }
                // console.log('Date After');
                // console.log(postdata[theName]);
              }


              if (theName.includes('ingestInfo')){
                postdata[theName] = null;
              }

{#              if (theName.includes('deployCruiseInfo')){
                if (!_.isNull(postdata[theName]) && postdata[theName].length > 0) {
                  postdata[theName] = "{" + postdata[theName] + "}";
                } else {
                  postdata[theName] = null;
                }
              }

              if (theName.includes('recoverCruiseInfo')){
                if (!_.isNull(postdata[theName]) && postdata[theName].length > 0) {
                  postdata[theName] = "{" + postdata[theName] + "}";
                } else {
                  postdata[theName] = null;
                }
              }#}
              // console.log(postdata[theName]);
            });
            // console.log('Full postdata');
            // console.log(postdata);

            postdata.eventName = 'DEPLOYMENT';

            return [true, ''];
          },
          closeOnEscape:true,
          closeAfterAdd:true,
          closeAfterEdit:true,
          width:800,
          top:120,
          left:50,
          recreateForm:true,
          reloadAfterSubmit : true,
          jqModal:true
        } /* edit options */
        ,{ajaxEditOptions: { contentType: "application/json; charset=utf-8" },
          serializeEditData: function (postdata) {
            return JSON.stringify(postdata);
          },
          errorTextFormat : function(serviceResponse){
            var messageText = JSON.parse(serviceResponse.responseText).message;
            return messageText;
          },
          beforeShowForm: function(id) {
            $('#dataSource').val('UI:user='+currentUser.responseJSON.user_name);
{#            $('#uid').attr('readonly', false);#}
{#            $('#rd').removeProp('readonly');#}
{#            $('#deploymentNumber').removeAttr('readonly');#}
{#            $('#versionNumber').removeAttr('readonly');#}
            $('#eventType').val('DEPLOYMENT');
          },
          onClose: function() {

          },
          afterSubmit : function(response, postdata)
          {
            var success = false;
            var message = response.statusText;
            // console.log(response);
            if(response.status == 200){
              success = true;
              message = "Record saved successfully.";
              refreshDeploymentsTable();
            }

            return [success,message]
          },
          beforeSubmit: function(postdata) {
                        // Form Validations
            if (!moment(postdata.eventStartTime, 'YYYY-MM-DD HH:mm:ss',true).isValid() && postdata.eventStartTime.length>0){
              return [false, 'Event Start Time format invalid (ex. 2014-09-23 09:45:12)'];
            }

            if (!moment(postdata.eventStopTime, 'YYYY-MM-DD HH:mm:ss',true).isValid() && postdata.eventStopTime.length>0){
              return [false, 'Event Stop Time format invalid (ex. 2014-09-23 09:45:12)'];
            }

            // Fix the dates
            if (!_.isNull(postdata.eventStartTime) && postdata.eventStartTime.length > 0) {
              postdata.eventStartTime = String(Date.parse(postdata.eventStartTime + " GMT"));
            } else {
              postdata.eventStartTime = '';
            }

            if (!_.isNull(postdata.eventStopTime) && postdata.eventStopTime.length > 0) {
              postdata.eventStopTime = String(Date.parse(postdata.eventStopTime + " GMT"));
            } else {
              postdata.eventStopTime = '';
            }

            var selRows = $dcGridDeployments.jqGrid('getGridParam','selrow');
            {#            // console.log(selRows);#}
            var currentRowData = $dcGridDeployments.getRowData(selRows);
            // console.log('currentRowData');
            // console.log(currentRowData);
            var theColModel = $dcGridDeployments.jqGrid('getGridParam', 'colModel');
            {#            // console.log(theColModel);#}
            {#            // console.log(postdata);#}
            $.each(theColModel, function() {
              var cm1 = this;
              var theName = cm1.name;
              {#              // console.log(theName);#}
              if (!(theName in postdata) && (theName != 'actions')) {
                {#                // console.log(currentRowData[theName]);#}
                if(theName == 'ingestInfo'){
                  postdata[theName] = "["+currentRowData[theName]+"]";
                } else {
                  postdata[theName] = currentRowData[theName];
                }

                // console.log(currentRowData[theName]);
                if(containsNonLatinCodepoints(currentRowData[theName])){
                  // console.log('unicode data detected');
                  // console.log(currentRowData[theName]);
                  postdata[theName] = "";
                }

              }

              if (theName.includes('Date')){
                // console.log('Date Before');
                // console.log(postdata[theName]);
                if (!_.isNull(postdata[theName]) && postdata[theName].length > 0) {
                  postdata[theName] = String(Date.parse(postdata[theName] + " GMT"));
                }
                // console.log('Date After');
                // console.log(postdata[theName]);
              }


              if (theName.includes('ingestInfo')){
                postdata[theName] = null;
              }

              if (theName.includes('deployCruiseInfo')){
                postdata[theName] = null;
              }

              if (theName.includes('recoverCruiseInfo')){
                postdata[theName] = null;
              }
              {#              // console.log(postdata[theName]);#}
            });
            // console.log('Full postdata');
            // console.log(postdata);

            return [true, ''];
          },
          closeOnEscape:true,
          closeAfterAdd:true,
          closeAfterEdit:true,
          width:800,
          top:120,
          left:50,
          recreateForm:true,
          reloadAfterSubmit : true,
          jqModal:true
        } /* add options */
        ,{} /*delete options*/
        ,{multipleSearch:false}
        ,{closeOnEscape:true}
      );

      // Column mover and chooser
      $dcGridDeployments.jqGrid('navButtonAdd', '#navGridDeployments', {
        caption: "showcolumns",
        buttonicon: "ui-icon-calculator",
        title: "Choose columns",
        onClickButton: function () {
          $(this).jqGrid('columnChooser',{});
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.selected")
            .bind("sortreceive", function (event, ui) {
              alert('column "' + ui.item.text() + '" is chosen');
            });
          $("#colchooser_" + $.jgrid.jqID(this.id) + " ul.available a.action")
            .click(function () {
              alert('column "' + $(this).parent().text() + '" is chosen');
            });

        }
      });



      if(location.hash!=""){
        setScienceFilter('ref_des', location.hash.split('#')[1]);
      }

      var performGlobalSearch = function(searchText) {
        var postData = $grid.jqGrid("getGridParam", "postData"),
          colModel = $grid.jqGrid("getGridParam", "colModel"),
          rules = [],
          {#          searchText = $("#globalSearchText").val(),#}
          l = colModel.length,
          searchTextParts = $.trim(searchText).match(/"([^"]+)"|'([^']+)'|\S+/g), //.split(separator),
          cnParts = searchTextParts === null ? 0 : searchTextParts.length,
          i,
          iPart,
          token,
          cm;

        // normalize searchTextParts by removing quotes
        for (iPart = 0; iPart < cnParts; iPart++) {
          token = searchTextParts[iPart];
          if (token.length > 2 &&
            ((token[0] === '"' && token[token.length - 1] === '"') ||
            (token[0] === "'" && token[token.length - 1] === "'"))) {
            searchTextParts[iPart] = token.substr(1,token.length-2);
          }
        }

        var textParts = {};
        for (k=0; k<cnParts; k++) {
          st = searchTextParts[k];
          textParts[st] = [];
          $.each(colModel, function() {
            var cm1 = this;
            if (cm1.search !== false && (cm1.stype === undefined || cm1.stype === "text") && (cm1.name != "start" && cm1.name != "end")) {
              textParts[st].push({groupOp:"OR",rules:[{field: cm1.name, op: "cn", data: st}]});
            }
          });
        }
        globalFilter = textParts;

        combineFilters();
      };

      // fill top toolbar
      var $grid = $dcGridDeployments;
      $('#t_' + $.jgrid.jqID($grid[0].id))
        .append($("<div><label for=\"globalSearchTextDeployments\">Global search in grid for:&nbsp;</label><input id=\"globalSearchTextDeployments\" type=\"text\"></input>&nbsp;<button id=\"globalSearchDeployments\" type=\"button\">Search</button></div>"));
      $("#globalSearchTextDeployments").keypress(function (e) {
        var key = e.charCode || e.keyCode || 0;
        if (key === $.ui.keyCode.ENTER) { // 13
          initialLocationSearch = "";
          performGlobalSearch($("#globalSearchTextDeployments").val());
        }
      });
      $("#globalSearchDeployments").button({
        icons: { primary: "ui-icon-search" },
        text: false
      }).click(function () {
        initialLocationSearch = "";
        performGlobalSearch($("#globalSearchTextDeployments").val());
      });

    } // placeJqGridDeployments















    var initDate = function (elem) {
      $(elem).datetimepicker({
        dateFormat: "dd/mm/yy",
        timeFormat: "HH:mm",
        //separator: " ",
        //autoSize: true,
        timezone: "000",
        changeYear: true,
        changeMonth: true,
        showButtonPanel: true,
        showWeek: true,
        onSelect: function () {
          var $grid, grid;
          if (typeof (elem.id) === "string" && elem.id.substr(0, 3) === "gs_") {
            $grid = $(elem).closest("div.ui-jqgrid-hdiv")
              .next("div.ui-jqgrid-bdiv")
              .find("table.ui-jqgrid-btable:first");
            if ($grid.length > 0) {
              grid = $grid[0];
              if ($.isFunction(grid.triggerToolbar)) {
                grid.triggerToolbar();
              }
            }
          } else {
            // to refresh the filter
            $(elem).trigger("change");
          }
        }
      });
      if ($(elem).val().length === 0) {
        $(elem).datepicker("setDate", new Date(2007, 10, 31));
      }
    };
    var dateTemplate = {align: "center", sorttype: "date", width: 124,
      editable: true, editoptions: { dataInit: initDate },
      searchoptions: {
        sopt: ["eq", "ne", "lt", "le", "gt", "ge"],
        attr: { maxlength: 10, size: 11 }, // for searching toolbar
        maxlength: 16, size: 17, // for searching dialog
        dataInit: initDate
      },
      formatter: "date", formatoptions: { srcformat: "U/1000", newformat: "ISO8601Long" }
    };

    var showAssets = function(collection, response){
      //jqGrid
      var jqCollection = {};
      {#      jqCollection['actions'] = '';#}
      $.ajax( '/api/deployments/subsites', {
        type: 'GET',
        dataType: 'json',
        success: function( resp ) {

        },
        complete: function(jsondata,stat){
          if(stat=="success") {
            {#              // console.log(jsondata.responseJSON);#}
            jqCollection = jsondata.responseJSON
          }
          // console.log(jqCollection);
          placeJqGrid(jqCollection);
          placeJqGridNodes();
          placeJqGridSensors();
          placeJqGridDeployments();
        },
        error: function( req, status, err ) {
          // console.log(req);
          // console.log(status);
          // console.log(err);
        },
        timeout : 60000
      });
    };

    var populate = function() {
      updateCollection( showAssets );
    };

    var updateCollection = function(successCallback){
      collection.fetch({
        success : successCallback
      });
    };

    var eventLocationFormatter = function(cellvalue) {
      return cellvalue[0].toString() + ", " + cellvalue[1].toString()
    };

    var isoToDateTime = function(cellvalue) {
      var temp = (String(cellvalue).search('Z') > 1) ? String(cellvalue).split('Z') : false;
      var returnDate = (true) ? new Date(Date.parse(temp[0])) : new Date(temp);
      return returnDate;
    };

    var dateTimeToISO = function(strInput) {
      var temp = Date.parse(strInput);
      var parseDate = new Date(temp);
      var isoDateReturn = parseDate.toISOString();
      return isoDateReturn;
    };

    var documentDef = function(obj) {
      var planDoc = [];
      if (obj) {
        planDoc = [
          'Data Source: ' + obj.dataSource,
          'Label: ' + obj.label,
          'Remote Resource ID: ' + obj.remoteResourceId,
          'Resource Number: ' + obj.resourceNumber];
      } else {
        planDoc = ["Plan not provided"];
      }
      return planDoc;
    };
  </script>
{% endblock %}
